var dt=Object.defineProperty;var vt=(u,v,k)=>v in u?dt(u,v,{enumerable:!0,configurable:!0,writable:!0,value:k}):u[v]=k;var R=(u,v,k)=>(vt(u,typeof v!="symbol"?v+"":v,k),k);(function(u,v){typeof exports=="object"&&typeof module!="undefined"?v(exports):typeof define=="function"&&define.amd?define(["exports"],v):(u=typeof globalThis!="undefined"?globalThis:u||self,v(u.ggg={}))})(this,function(u){"use strict";var v={Note:"Note",Rest:"Rest",Octave:"Octave",OctaveShift:"OctaveShift",NoteLength:"NoteLength",NoteVelocity:"NoteVelocity",NoteQuantize:"NoteQuantize",Tempo:"Tempo",InfiniteLoop:"InfiniteLoop",LoopBegin:"LoopBegin",LoopExit:"LoopExit",LoopEnd:"LoopEnd"},k={tempo:120,octave:4,length:4,velocity:100,quantize:75,loopCount:2},me=function(){function e(i,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(i,r.key,r)}}return function(i,t,n){return t&&e(i.prototype,t),n&&e(i,n),i}}();function ge(e,i){if(!(e instanceof i))throw new TypeError("Cannot call a class as a function")}var xe=function(){function e(i){ge(this,e),this.source=i,this.index=0}return me(e,[{key:"hasNext",value:function(){return this.index<this.source.length}},{key:"peek",value:function(){return this.source.charAt(this.index)||""}},{key:"next",value:function(){return this.source.charAt(this.index++)||""}},{key:"forward",value:function(){for(;this.hasNext()&&this.match(/\s/);)this.index+=1}},{key:"match",value:function(t){return t instanceof RegExp?t.test(this.peek()):this.peek()===t}},{key:"expect",value:function(t){this.match(t)||this.throwUnexpectedToken(),this.index+=1}},{key:"scan",value:function(t){var n=this.source.substr(this.index),r=null;if(t instanceof RegExp){var o=t.exec(n);o&&o.index===0&&(r=o[0])}else n.substr(0,t.length)===t&&(r=t);return r&&(this.index+=r.length),r}},{key:"throwUnexpectedToken",value:function(){var t=this.peek()||"ILLEGAL";throw new SyntaxError("Unexpected token: "+t)}}]),e}(),we=xe,be=function(){function e(i,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(i,r.key,r)}}return function(i,t,n){return t&&e(i.prototype,t),n&&e(i,n),i}}();function ke(e,i){if(!(e instanceof i))throw new TypeError("Cannot call a class as a function")}var m=v,qe=we,Se={c:0,d:2,e:4,f:5,g:7,a:9,b:11},Me=function(){function e(i){ke(this,e),this.scanner=new qe(i)}return be(e,[{key:"parse",value:function(){var t=this,n=[];return this._readUntil(";",function(){n=n.concat(t.advance())}),n}},{key:"advance",value:function(){switch(this.scanner.peek()){case"c":case"d":case"e":case"f":case"g":case"a":case"b":return this.readNote();case"[":return this.readChord();case"r":return this.readRest();case"o":return this.readOctave();case">":return this.readOctaveShift(1);case"<":return this.readOctaveShift(-1);case"l":return this.readNoteLength();case"q":return this.readNoteQuantize();case"v":return this.readNoteVelocity();case"t":return this.readTempo();case"$":return this.readInfiniteLoop();case"/":return this.readLoop()}this.scanner.throwUnexpectedToken()}},{key:"readNote",value:function(){return{type:m.Note,noteNumbers:[this._readNoteNumber(0)],noteLength:this._readLength()}}},{key:"readChord",value:function(){var t=this;this.scanner.expect("[");var n=[],r=0;return this._readUntil("]",function(){switch(t.scanner.peek()){case"c":case"d":case"e":case"f":case"g":case"a":case"b":n.push(t._readNoteNumber(r));break;case">":t.scanner.next(),r+=12;break;case"<":t.scanner.next(),r-=12;break;default:t.scanner.throwUnexpectedToken()}}),this.scanner.expect("]"),{type:m.Note,noteNumbers:n,noteLength:this._readLength()}}},{key:"readRest",value:function(){return this.scanner.expect("r"),{type:m.Rest,noteLength:this._readLength()}}},{key:"readOctave",value:function(){return this.scanner.expect("o"),{type:m.Octave,value:this._readArgument(/\d+/)}}},{key:"readOctaveShift",value:function(t){return this.scanner.expect(/<|>/),{type:m.OctaveShift,direction:t|0,value:this._readArgument(/\d+/)}}},{key:"readNoteLength",value:function(){return this.scanner.expect("l"),{type:m.NoteLength,noteLength:this._readLength()}}},{key:"readNoteQuantize",value:function(){return this.scanner.expect("q"),{type:m.NoteQuantize,value:this._readArgument(/\d+/)}}},{key:"readNoteVelocity",value:function(){return this.scanner.expect("v"),{type:m.NoteVelocity,value:this._readArgument(/\d+/)}}},{key:"readTempo",value:function(){return this.scanner.expect("t"),{type:m.Tempo,value:this._readArgument(/\d+(\.\d+)?/)}}},{key:"readInfiniteLoop",value:function(){return this.scanner.expect("$"),{type:m.InfiniteLoop}}},{key:"readLoop",value:function(){var t=this;this.scanner.expect("/"),this.scanner.expect(":");var n={type:m.LoopBegin},r={type:m.LoopEnd},o=[];return o=o.concat(n),this._readUntil(/[|:]/,function(){o=o.concat(t.advance())}),o=o.concat(this._readLoopExit()),this.scanner.expect(":"),this.scanner.expect("/"),n.value=this._readArgument(/\d+/)||null,o=o.concat(r),o}},{key:"_readUntil",value:function(t,n){for(;this.scanner.hasNext()&&(this.scanner.forward(),!(!this.scanner.hasNext()||this.scanner.match(t)));)n()}},{key:"_readArgument",value:function(t){var n=this.scanner.scan(t);return n!==null?+n:null}},{key:"_readNoteNumber",value:function(t){var n=Se[this.scanner.next()];return n+this._readAccidental()+t}},{key:"_readAccidental",value:function(){return this.scanner.match("+")?1*this.scanner.scan(/\++/).length:this.scanner.match("-")?-1*this.scanner.scan(/\-+/).length:0}},{key:"_readDot",value:function(){for(var t=(this.scanner.scan(/\.+/)||"").length,n=new Array(t),r=0;r<t;r++)n[r]=0;return n}},{key:"_readLength",value:function(){var t=[];t=t.concat(this._readArgument(/\d+/)),t=t.concat(this._readDot());var n=this._readTie();return n&&(t=t.concat(n)),t}},{key:"_readTie",value:function(){return this.scanner.forward(),this.scanner.match("^")?(this.scanner.next(),this._readLength()):null}},{key:"_readLoopExit",value:function(){var t=this,n=[];if(this.scanner.match("|")){this.scanner.next();var r={type:m.LoopExit};n=n.concat(r),this._readUntil(":",function(){n=n.concat(t.advance())})}return n}}]),e}(),Ne=Me,Le=function(){function e(i,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(i,r.key,r)}}return function(i,t,n){return t&&e(i.prototype,t),n&&e(i,n),i}}();function Te(e,i){if(!(e instanceof i))throw new TypeError("Cannot call a class as a function")}var y=v,g=k,Ie=Ne,Ee=typeof Symbol!="undefined"?Symbol.iterator:"@@iterator",Oe=function(){function e(i){Te(this,e),this.source=i,this._commands=new Ie(i).parse(),this._commandIndex=0,this._processedTime=0,this._iterator=null,this._octave=g.octave,this._noteLength=[g.length],this._velocity=g.velocity,this._quantize=g.quantize,this._tempo=g.tempo,this._infiniteLoopIndex=-1,this._loopStack=[],this._done=!1}return Le(e,[{key:"hasNext",value:function(){return this._commandIndex<this._commands.length}},{key:"next",value:function(){if(this._done)return{done:!0,value:null};if(this._iterator){var t=this._iterator.next();if(!t.done)return t}var n=this._forward(!0);if(te(n))this._iterator=this[n.type](n);else return this._done=!0,{done:!1,value:{type:"end",time:this._processedTime}};return this.next()}},{key:Ee,value:function(){return this}},{key:"_forward",value:function(t){for(;this.hasNext()&&!te(this._commands[this._commandIndex]);){var n=this._commands[this._commandIndex++];this[n.type](n)}return t&&!this.hasNext()&&this._infiniteLoopIndex!==-1?(this._commandIndex=this._infiniteLoopIndex,this._forward(!1)):this._commands[this._commandIndex++]||{}}},{key:"_calcDuration",value:function(t){var n=this;t[0]===null&&(t=this._noteLength.concat(t.slice(1)));var r=null,o=0;return t=t.map(function(h){switch(h){case null:h=r;break;case 0:h=o*=2;break;default:r=o=h;break}var p=h!==null?h:g.length;return 60/n._tempo*(4/p)}),t.reduce(function(h,p){return h+p},0)}},{key:"_calcNoteNumber",value:function(t){return t+this._octave*12+12}},{key:y.Note,value:function(t){var n=this,r="note",o=this._processedTime,h=this._calcDuration(t.noteLength),p=t.noteNumbers.map(function(_){return n._calcNoteNumber(_)}),l=this._quantize,c=this._velocity;return this._processedTime=this._processedTime+h,Ce(p.map(function(_){return{type:r,time:o,duration:h,noteNumber:_,velocity:c,quantize:l}}))}},{key:y.Rest,value:function(t){var n=this._calcDuration(t.noteLength);this._processedTime=this._processedTime+n}},{key:y.Octave,value:function(t){this._octave=t.value!==null?t.value:g.octave}},{key:y.OctaveShift,value:function(t){var n=t.value!==null?t.value:1;this._octave+=n*t.direction}},{key:y.NoteLength,value:function(t){var n=t.noteLength.map(function(r){return r!==null?r:g.length});this._noteLength=n}},{key:y.NoteVelocity,value:function(t){this._velocity=t.value!==null?t.value:g.velocity}},{key:y.NoteQuantize,value:function(t){this._quantize=t.value!==null?t.value:g.quantize}},{key:y.Tempo,value:function(t){this._tempo=t.value!==null?t.value:g.tempo}},{key:y.InfiniteLoop,value:function(){this._infiniteLoopIndex=this._commandIndex}},{key:y.LoopBegin,value:function(t){var n=t.value!==null?t.value:g.loopCount,r=this._commandIndex,o=-1;this._loopStack.push({loopCount:n,loopTopIndex:r,loopOutIndex:o})}},{key:y.LoopExit,value:function(){var t=this._loopStack[this._loopStack.length-1],n=this._commandIndex;t.loopCount<=1&&t.loopOutIndex!==-1&&(n=t.loopOutIndex),this._commandIndex=n}},{key:y.LoopEnd,value:function(){var t=this._loopStack[this._loopStack.length-1],n=this._commandIndex;t.loopOutIndex===-1&&(t.loopOutIndex=this._commandIndex),t.loopCount-=1,0<t.loopCount?n=t.loopTopIndex:this._loopStack.pop(),this._commandIndex=n}}]),e}();function Ce(e){var i=0;return{next:function(){return i<e.length?{done:!1,value:e[i++]}:{done:!0}}}}function te(e){return e.type===y.Note||e.type===y.Rest}var ze=Oe,Re=ze;let b,ie,j,ne,ae=!1;function Ae(e=void 0){window.AudioContext=window.AudioContext||window.webkitAudioContext,b=e==null?new AudioContext:e,re(),se()}function Pe(){ae||(ae=!0,$e())}function re(e=150){ie=e,j=60/ie}function se(e=8){ne=4/e}function J(e){const i=j*ne;return i>0?Math.ceil(e/i)*i:e}function $e(){const e=b.createBufferSource();e.start=e.start||e.noteOn,e.start()}let q=Math.random();function Ue(e){q=e}var T=0,I=1,A=2,P=3,De=1,$=8;function d(){this.oldParams=!0,this.wave_type=T,this.p_env_attack=0,this.p_env_sustain=.3,this.p_env_punch=0,this.p_env_decay=.4,this.p_base_freq=.3,this.p_freq_limit=0,this.p_freq_ramp=0,this.p_freq_dramp=0,this.p_vib_strength=0,this.p_vib_speed=0,this.p_arp_mod=0,this.p_arp_speed=0,this.p_duty=0,this.p_duty_ramp=0,this.p_repeat_speed=0,this.p_pha_offset=0,this.p_pha_ramp=0,this.p_lpf_freq=1,this.p_lpf_ramp=0,this.p_lpf_resonance=0,this.p_hpf_freq=0,this.p_hpf_ramp=0,this.sound_vol=.5,this.sample_rate=44100,this.sample_size=8}function U(e){return e*e}function oe(e){return e*e*e}var Be=Math.pow;function a(e){return q()*e}function S(e,i){return q()*(i-e)+e}function s(e){return Math.floor(q()*(e+1))}function D(e,i,t){return e<<31|i<<23|t}function Qe(e){if(isNaN(e))return D(0,255,4919);var i=e<0?1:0;if(e=Math.abs(e),e==0)return D(i,0,0);var t=Math.floor(Math.log(e)/Math.LN2);if(t>127||t<-126)return D(i,255,0);var n=e/Math.pow(2,t);return D(i,t+127,n*Math.pow(2,23)&8388607)}var Fe="123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz",he=["wave_type","p_env_attack","p_env_sustain","p_env_punch","p_env_decay","p_base_freq","p_freq_limit","p_freq_ramp","p_freq_dramp","p_vib_strength","p_vib_speed","p_arp_mod","p_arp_speed","p_duty","p_duty_ramp","p_repeat_speed","p_pha_offset","p_pha_ramp","p_lpf_freq","p_lpf_ramp","p_lpf_resonance","p_hpf_freq","p_hpf_ramp"];d.prototype.toB58=function(){var e=[];for(var i in he){var t=he[i];if(t=="wave_type")e.push(this[t]);else if(t.indexOf("p_")==0){var n=this[t];n=Qe(n),e.push(255&n),e.push(255&n>>8),e.push(255&n>>16),e.push(255&n>>24)}}return function(r,o){var h=[],p="",l,c,_,x;for(l in r)for(c=0,_=r[l],p+=_||p.length^l?"":1;c in h||_;)x=h[c],x=x?x*256+_:_,_=x/58|0,h[c]=x%58,c++;for(;c--;)p+=o[h[c]];return p}(e,Fe)},d.prototype.fromB58=function(e){return this.fromJSON(Ve.b58decode(e)),this},d.prototype.fromJSON=function(e){for(var i in e)e.hasOwnProperty(i)&&(this[i]=e[i]);return this},d.prototype.pickupCoin=function(){return this.wave_type=I,this.p_base_freq=.4+a(.5),this.p_env_attack=0,this.p_env_sustain=a(.1),this.p_env_decay=.1+a(.4),this.p_env_punch=.3+a(.3),s(1)&&(this.p_arp_speed=.5+a(.2),this.p_arp_mod=.2+a(.4)),this},d.prototype.laserShoot=function(){return this.wave_type=s(2),this.wave_type===A&&s(1)&&(this.wave_type=s(1)),s(2)===0?(this.p_base_freq=.3+a(.6),this.p_freq_limit=a(.1),this.p_freq_ramp=-.35-a(.3)):(this.p_base_freq=.5+a(.5),this.p_freq_limit=this.p_base_freq-.2-a(.6),this.p_freq_limit<.2&&(this.p_freq_limit=.2),this.p_freq_ramp=-.15-a(.2)),this.wave_type===I&&(this.p_duty=1),s(1)?(this.p_duty=a(.5),this.p_duty_ramp=a(.2)):(this.p_duty=.4+a(.5),this.p_duty_ramp=-a(.7)),this.p_env_attack=0,this.p_env_sustain=.1+a(.2),this.p_env_decay=a(.4),s(1)&&(this.p_env_punch=a(.3)),s(2)===0&&(this.p_pha_offset=a(.2),this.p_pha_ramp=-a(.2)),this.p_hpf_freq=a(.3),this},d.prototype.explosion=function(){return this.wave_type=P,s(1)?(this.p_base_freq=U(.1+a(.4)),this.p_freq_ramp=-.1+a(.4)):(this.p_base_freq=U(.2+a(.7)),this.p_freq_ramp=-.2-a(.2)),s(4)===0&&(this.p_freq_ramp=0),s(2)===0&&(this.p_repeat_speed=.3+a(.5)),this.p_env_attack=0,this.p_env_sustain=.1+a(.3),this.p_env_decay=a(.5),s(1)&&(this.p_pha_offset=-.3+a(.9),this.p_pha_ramp=-a(.3)),this.p_env_punch=.2+a(.6),s(1)&&(this.p_vib_strength=a(.7),this.p_vib_speed=a(.6)),s(2)===0&&(this.p_arp_speed=.6+a(.3),this.p_arp_mod=.8-a(1.6)),this},d.prototype.powerUp=function(){return s(1)?(this.wave_type=I,this.p_duty=1):this.p_duty=a(.6),this.p_base_freq=.2+a(.3),s(1)?(this.p_freq_ramp=.1+a(.4),this.p_repeat_speed=.4+a(.4)):(this.p_freq_ramp=.05+a(.2),s(1)&&(this.p_vib_strength=a(.7),this.p_vib_speed=a(.6))),this.p_env_attack=0,this.p_env_sustain=a(.4),this.p_env_decay=.1+a(.4),this},d.prototype.hitHurt=function(){return this.wave_type=s(2),this.wave_type===A&&(this.wave_type=P),this.wave_type===T&&(this.p_duty=a(.6)),this.wave_type===I&&(this.p_duty=1),this.p_base_freq=.2+a(.6),this.p_freq_ramp=-.3-a(.4),this.p_env_attack=0,this.p_env_sustain=a(.1),this.p_env_decay=.1+a(.2),s(1)&&(this.p_hpf_freq=a(.3)),this},d.prototype.jump=function(){return this.wave_type=T,this.p_duty=a(.6),this.p_base_freq=.3+a(.3),this.p_freq_ramp=.1+a(.2),this.p_env_attack=0,this.p_env_sustain=.1+a(.3),this.p_env_decay=.1+a(.2),s(1)&&(this.p_hpf_freq=a(.3)),s(1)&&(this.p_lpf_freq=1-a(.6)),this},d.prototype.blipSelect=function(){return this.wave_type=s(1),this.wave_type===T?this.p_duty=a(.6):this.p_duty=1,this.p_base_freq=.2+a(.4),this.p_env_attack=0,this.p_env_sustain=.1+a(.1),this.p_env_decay=a(.2),this.p_hpf_freq=.1,this},d.prototype.synth=function(){return this.wave_type=s(1),this.p_base_freq=[.2723171360931539,.19255692561524382,.13615778746815113][s(2)],this.p_env_attack=s(4)>3?a(.5):0,this.p_env_sustain=a(1),this.p_env_punch=a(1),this.p_env_decay=a(.9)+.1,this.p_arp_mod=[0,0,0,0,-.3162,.7454,.7454][s(6)],this.p_arp_speed=a(.5)+.4,this.p_duty=a(1),this.p_duty_ramp=s(2)==2?a(1):0,this.p_lpf_freq=[1,a(1)*a(1)][s(1)],this.p_lpf_ramp=S(-1,1),this.p_lpf_resonance=a(1),this.p_hpf_freq=s(3)==3?a(1):0,this.p_hpf_ramp=s(3)==3?a(1):0,this},d.prototype.tone=function(){return this.wave_type=A,this.p_base_freq=.35173364,this.p_env_attack=0,this.p_env_sustain=.6641,this.p_env_decay=0,this.p_env_punch=0,this},d.prototype.click=function(){const e=["explosion","hitHurt"][s(1)];return this[e](),s(1)&&(this.p_freq_ramp=-.5+a(1)),s(1)&&(this.p_env_sustain=(a(.4)+.2)*this.p_env_sustain,this.p_env_decay=(a(.4)+.2)*this.p_env_decay),s(3)==0&&(this.p_env_attack=a(.3)),this.p_base_freq=1-a(.25),this.p_hpf_freq=1-a(.1),this},d.prototype.random=function(){return this.wave_type=s(3),s(1)?this.p_base_freq=oe(a(2)-1)+.5:this.p_base_freq=U(a(1)),this.p_freq_limit=0,this.p_freq_ramp=Math.pow(a(2)-1,5),this.p_base_freq>.7&&this.p_freq_ramp>.2&&(this.p_freq_ramp=-this.p_freq_ramp),this.p_base_freq<.2&&this.p_freq_ramp<-.05&&(this.p_freq_ramp=-this.p_freq_ramp),this.p_freq_dramp=Math.pow(a(2)-1,3),this.p_duty=a(2)-1,this.p_duty_ramp=Math.pow(a(2)-1,3),this.p_vib_strength=Math.pow(a(2)-1,3),this.p_vib_speed=S(-1,1),this.p_env_attack=oe(S(-1,1)),this.p_env_sustain=U(S(-1,1)),this.p_env_decay=S(-1,1),this.p_env_punch=Math.pow(a(.8),2),this.p_env_attack+this.p_env_sustain+this.p_env_decay<.2&&(this.p_env_sustain+=.2+a(.3),this.p_env_decay+=.2+a(.3)),this.p_lpf_resonance=S(-1,1),this.p_lpf_freq=1-Math.pow(a(1),3),this.p_lpf_ramp=Math.pow(a(2)-1,3),this.p_lpf_freq<.1&&this.p_lpf_ramp<-.05&&(this.p_lpf_ramp=-this.p_lpf_ramp),this.p_hpf_freq=Math.pow(a(1),5),this.p_hpf_ramp=Math.pow(a(2)-1,5),this.p_pha_offset=Math.pow(a(2)-1,3),this.p_pha_ramp=Math.pow(a(2)-1,3),this.p_repeat_speed=a(2)-1,this.p_arp_speed=a(2)-1,this.p_arp_mod=a(2)-1,this},d.prototype.mutate=function(){return s(1)&&(this.p_base_freq+=a(.1)-.05),s(1)&&(this.p_freq_ramp+=a(.1)-.05),s(1)&&(this.p_freq_dramp+=a(.1)-.05),s(1)&&(this.p_duty+=a(.1)-.05),s(1)&&(this.p_duty_ramp+=a(.1)-.05),s(1)&&(this.p_vib_strength+=a(.1)-.05),s(1)&&(this.p_vib_speed+=a(.1)-.05),s(1)&&(this.p_vib_delay+=a(.1)-.05),s(1)&&(this.p_env_attack+=a(.1)-.05),s(1)&&(this.p_env_sustain+=a(.1)-.05),s(1)&&(this.p_env_decay+=a(.1)-.05),s(1)&&(this.p_env_punch+=a(.1)-.05),s(1)&&(this.p_lpf_resonance+=a(.1)-.05),s(1)&&(this.p_lpf_freq+=a(.1)-.05),s(1)&&(this.p_lpf_ramp+=a(.1)-.05),s(1)&&(this.p_hpf_freq+=a(.1)-.05),s(1)&&(this.p_hpf_ramp+=a(.1)-.05),s(1)&&(this.p_pha_offset+=a(.1)-.05),s(1)&&(this.p_pha_ramp+=a(.1)-.05),s(1)&&(this.p_repeat_speed+=a(.1)-.05),s(1)&&(this.p_arp_speed+=a(.1)-.05),s(1)&&(this.p_arp_mod+=a(.1)-.05),this};const Ve={};function E(e){this.init(e)}E.prototype.init=function(e){this.parameters=e,this.initForRepeat(),this.waveShape=parseInt(e.wave_type),this.fltw=Math.pow(e.p_lpf_freq,3)*.1,this.enableLowPassFilter=e.p_lpf_freq!=1,this.fltw_d=1+e.p_lpf_ramp*1e-4,this.fltdmp=5/(1+Math.pow(e.p_lpf_resonance,2)*20)*(.01+this.fltw),this.fltdmp>.8&&(this.fltdmp=.8),this.flthp=Math.pow(e.p_hpf_freq,2)*.1,this.flthp_d=1+e.p_hpf_ramp*3e-4,this.vibratoSpeed=Math.pow(e.p_vib_speed,2)*.01,this.vibratoAmplitude=e.p_vib_strength*.5,this.envelopeLength=[Math.floor(e.p_env_attack*e.p_env_attack*1e5),Math.floor(e.p_env_sustain*e.p_env_sustain*1e5),Math.floor(e.p_env_decay*e.p_env_decay*1e5)],this.envelopePunch=e.p_env_punch,this.flangerOffset=Math.pow(e.p_pha_offset,2)*1020,e.p_pha_offset<0&&(this.flangerOffset=-this.flangerOffset),this.flangerOffsetSlide=Math.pow(e.p_pha_ramp,2)*1,e.p_pha_ramp<0&&(this.flangerOffsetSlide=-this.flangerOffsetSlide),this.repeatTime=Math.floor(Math.pow(1-e.p_repeat_speed,2)*2e4+32),e.p_repeat_speed===0&&(this.repeatTime=0),this.gain=Math.exp(e.sound_vol)-1,this.sampleRate=e.sample_rate,this.bitsPerChannel=e.sample_size},E.prototype.initForRepeat=function(){var e=this.parameters;this.elapsedSinceRepeat=0,this.period=100/(e.p_base_freq*e.p_base_freq+.001),this.periodMax=100/(e.p_freq_limit*e.p_freq_limit+.001),this.enableFrequencyCutoff=e.p_freq_limit>0,this.periodMult=1-Math.pow(e.p_freq_ramp,3)*.01,this.periodMultSlide=-Math.pow(e.p_freq_dramp,3)*1e-6,this.dutyCycle=.5-e.p_duty*.5,this.dutyCycleSlide=-e.p_duty_ramp*5e-5,e.p_arp_mod>=0?this.arpeggioMultiplier=1-Math.pow(e.p_arp_mod,2)*.9:this.arpeggioMultiplier=1+Math.pow(e.p_arp_mod,2)*10,this.arpeggioTime=Math.floor(Math.pow(1-e.p_arp_speed,2)*2e4+32),e.p_arp_speed===1&&(this.arpeggioTime=0)},E.prototype.getRawBuffer=function(){for(var e=0,i=0,t=0,n=Array(32),r=0;r<32;++r)n[r]=q()*2-1;for(var o=0,h=0,p=0,l=0,c=0,_=Array(1024),r=0;r<1024;++r)_[r]=0;for(var x=0,F=[],Y=0,ce=0,le=Math.floor(44100/this.sampleRate),de=0;this.repeatTime!=0&&++this.elapsedSinceRepeat>=this.repeatTime&&this.initForRepeat(),this.arpeggioTime!=0&&de>=this.arpeggioTime&&(this.arpeggioTime=0,this.period*=this.arpeggioMultiplier),this.periodMult+=this.periodMultSlide,this.period*=this.periodMult,!(this.period>this.periodMax&&(this.period=this.periodMax,this.enableFrequencyCutoff));++de){var ve=this.period;this.vibratoAmplitude>0&&(p+=this.vibratoSpeed,ve=this.period*(1+Math.sin(p)*this.vibratoAmplitude));var L=Math.floor(ve);if(L<$&&(L=$),this.dutyCycle+=this.dutyCycleSlide,this.dutyCycle<0&&(this.dutyCycle=0),this.dutyCycle>.5&&(this.dutyCycle=.5),++h>this.envelopeLength[o]&&(h=0,++o>2))break;var V,Z=h/this.envelopeLength[o];o===0?V=Z:o===1?V=1+(1-Z)*2*this.envelopePunch:V=1-Z,this.flangerOffset+=this.flangerOffsetSlide;var ee=Math.abs(Math.floor(this.flangerOffset));ee>1023&&(ee=1023),this.flthp_d!=0&&(this.flthp*=this.flthp_d,this.flthp<1e-5&&(this.flthp=1e-5),this.flthp>.1&&(this.flthp=.1));for(var f=0,ye=0;ye<$;++ye){var w=0;if(l++,l>=L&&(l%=L,this.waveShape===P))for(var r=0;r<32;++r)n[r]=q()*2-1;var z=l/L;if(this.waveShape===T)z<this.dutyCycle?w=.5:w=-.5;else if(this.waveShape===I)z<this.dutyCycle?w=-1+2*z/this.dutyCycle:w=1-2*(z-this.dutyCycle)/(1-this.dutyCycle);else if(this.waveShape===A)w=Math.sin(z*2*Math.PI);else if(this.waveShape===P)w=n[Math.floor(l*32/L)];else throw"ERROR: Bad wave type: "+this.waveShape;var lt=e;this.fltw*=this.fltw_d,this.fltw<0&&(this.fltw=0),this.fltw>.1&&(this.fltw=.1),this.enableLowPassFilter?(i+=(w-e)*this.fltw,i-=i*this.fltdmp):(e=w,i=0),e+=i,t+=e-lt,t-=t*this.flthp,w=t,_[c&1023]=w,w+=_[c-ee+1024&1023],c=c+1&1023,f+=w*V}if(Y+=f,++ce>=le)ce=0,f=Y/le,Y=0;else continue;f=f/$*De,f*=this.gain,this.bitsPerChannel===8?(f=Math.floor((f+1)*128),f>255?(f=255,++x):f<0&&(f=0,++x),F.push(f)):(f=Math.floor(f*(1<<15)),f>=1<<15?(f=(1<<15)-1,++x):f<-(1<<15)&&(f=-(1<<15),++x),F.push(f&255),F.push(f>>8&255))}return{buffer:F,clipped:x}},E.prototype.generate=function(){var e=this.getRawBuffer(),i=je(e.buffer,this.bitsPerChannel);return{sampleRate:this.sampleRate,bitsPerChannel:this.bitsPerChannel,buffer:i,clipped:e.clipped}};var je=function(e,i){for(var t=new Float32Array(e.length),n=0;n<e.length;n++)t[n]=2*e[n]/Be(2,i)-1;return t};class Je{constructor(i=null){R(this,"x");R(this,"y");R(this,"z");R(this,"w");this.setSeed(i)}get(i=1,t){return t==null&&(t=i,i=0),this.next()/4294967295*(t-i)+i}getInt(i,t){t==null&&(t=i,i=0);const n=Math.floor(i),r=Math.floor(t);return r===n?n:this.next()%(r-n)+n}getPlusOrMinus(){return this.getInt(2)*2-1}select(i){return i[this.getInt(i.length)]}setSeed(i,t=123456789,n=362436069,r=521288629,o=32){this.w=i!=null?i>>>0:Math.floor(Math.random()*4294967295)>>>0,this.x=t>>>0,this.y=n>>>0,this.z=r>>>0;for(let h=0;h<o;h++)this.next();return this}getState(){return{x:this.x,y:this.y,z:this.z,w:this.w}}next(){const i=this.x^this.x<<11;return this.x=this.y,this.y=this.z,this.z=this.w,this.w=(this.w^this.w>>>19^(i^i>>>8))>>>0,this.w}}const pe=new Je;function Ge(e,i){let t=[];for(let n=0;n<e;n++)t.push(i(n));return t}const We={coin:"pickupCoin",laser:"laserShoot",explosion:"explosion",powerUp:"powerUp",hit:"hitHurt",jump:"jump",select:"blipSelect",synth:"synth",tone:"tone",click:"click",random:"random"};let G;function Xe(){G=[],Ue(()=>pe.get())}function He(e){et(e)}function Ke(){const e=b.currentTime;G.forEach(i=>{tt(i,e)})}function Ye(e,i,t=2,n=.1,r=void 0,o=1,h=1){const p=Ge(t,c=>{pe.setSeed(i+c*1063);let _=new d;return _[We[e]](),r!=null&&(_.p_base_freq=r),_.p_env_attack*=o,_.p_env_sustain*=h,_}),l=fe({type:e,params:p,volume:n});return G.push(l),l}function Ze(e,i){e.gainNode.gain.value=i}function et(e){e.isPlaying=!0}function tt(e,i){if(!e.isPlaying)return;e.isPlaying=!1;const t=J(i);(e.playedTime==null||t>e.playedTime)&&(W(e,t),e.playedTime=t)}function W(e,i,t=void 0){e.bufferSourceNodes=[],e.buffers.forEach(n=>{const r=b.createBufferSource();if(r.buffer=n,t!=null&&r.playbackRate!=null){const o=Math.pow(2,1/12);r.playbackRate.value=Math.pow(o,t)}r.start=r.start||r.noteOn,r.connect(e.gainNode),r.start(i),e.bufferSourceNodes.push(r)})}function X(e,i=void 0){e.bufferSourceNodes!=null&&(e.bufferSourceNodes.forEach(t=>{i==null?t.stop():t.stop(i)}),e.bufferSourceNodes=void 0)}function fe(e){const i=e.type,t=e.params,n=e.volume,r=t.map(h=>{const p=new E(h).generate();if(p.buffer.length===0)return b.createBuffer(1,1,p.sampleRate);const l=b.createBuffer(1,p.buffer.length,p.sampleRate);var c=l.getChannelData(0);return c.set(p.buffer),l}),o=b.createGain();return o.gain.value=n,o.connect(b.destination),{type:i,params:t,volume:n,buffers:r,bufferSourceNodes:void 0,gainNode:o,isPlaying:!1,playedTime:void 0}}function it(e,i,t,n,r){return{mml:e,sequence:i,soundEffect:t,isDrum:n,noteIndex:0,endStep:-1,visualizer:r}}function nt(e,i){return{mml:e.mml,sequence:i(e.mml,O),soundEffect:fe(e.soundEffect),isDrum:e.isDrum,noteIndex:0,endStep:-1}}let B,O,M,H,N,K=!1;function at(e,i){B=e,O=i,M=0,H=j/2,N=J(b.currentTime)-H,B.forEach(t=>{t.noteIndex=0}),K=!0}function rt(){K=!1,B.forEach(e=>{X(e.soundEffect)})}function st(){if(!K)return;const e=b.currentTime;e<N||(N+=H,N<e&&(N=J(e)),B.forEach(i=>{ot(i,N)}),M++,M>=O&&(M=0))}function ot(e,i){const t=e.sequence.notes[e.noteIndex];t!=null&&((e.soundEffect.type==="synth"||e.soundEffect.type==="tone")&&e.endStep===M&&X(e.soundEffect,i),t.quantizedStartStep===M&&((e.soundEffect.type==="synth"||e.soundEffect.type==="tone")&&X(e.soundEffect),e.isDrum?W(e.soundEffect,i):W(e.soundEffect,i,t.pitch-69),e.visualizer!=null&&e.visualizer.redraw(t),e.endStep=t.quantizedEndStep,e.endStep>=O&&(e.endStep-=O),e.noteIndex++,e.noteIndex>=e.sequence.notes.length&&(e.noteIndex=0)))}const ue=.125;let _e,Q;const C=navigator.userAgent.indexOf("Safari")>-1&&navigator.userAgent.indexOf("Chrome")<0;function ht(e,i=.1){if(C)return;const t=e.parts.map(n=>{const r=nt(n,ct);return Ze(r.soundEffect,r.soundEffect.volume*i/.2),it(r.mml,r.sequence,r.soundEffect,r.isDrum)});at(t,e.notesStepsCount)}function pt(){C||rt()}function ft(e,i=void 0,t=2,n=.1,r=void 0){if(C)return;const o=`${e}_${i}_${t}_${n}_${r}`;Q[o]==null&&(Q[o]=Ye(e,i==null?_e:i,t,n,r)),He(Q[o])}function ut(){C||(st(),Ke())}function _t(e=1,i=void 0){C||(_e=e,Ae(i),Xe(),Q={})}function ct(e,i){const t=[],n=new Re(e);for(let r of n)if(r.type==="note"){let o=Math.floor(r.time+r.duration/ue);o>=i&&(o-=i),t.push({pitch:r.noteNumber,quantizedStartStep:Math.floor(r.time/ue),endStep:o})}return{notes:t}}u.init=_t,u.playMml=ht,u.playSoundEffect=ft,u.setQuantize=se,u.setTempo=re,u.startAudio=Pe,u.stopMml=pt,u.update=ut,Object.defineProperty(u,"__esModule",{value:!0}),u[Symbol.toStringTag]="Module"});
