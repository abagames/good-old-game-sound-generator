var yt=Object.defineProperty;var gt=(S,A,q)=>A in S?yt(S,A,{enumerable:!0,configurable:!0,writable:!0,value:q}):S[A]=q;var z=(S,A,q)=>(gt(S,typeof A!="symbol"?A+"":A,q),q);(function(S,A){typeof exports=="object"&&typeof module!="undefined"?A(exports):typeof define=="function"&&define.amd?define(["exports"],A):(S=typeof globalThis!="undefined"?globalThis:S||self,A(S.ggg={}))})(this,function(S){"use strict";var A={Note:"Note",Rest:"Rest",Octave:"Octave",OctaveShift:"OctaveShift",NoteLength:"NoteLength",NoteVelocity:"NoteVelocity",NoteQuantize:"NoteQuantize",Tempo:"Tempo",InfiniteLoop:"InfiniteLoop",LoopBegin:"LoopBegin",LoopExit:"LoopExit",LoopEnd:"LoopEnd"},q={tempo:120,octave:4,length:4,velocity:100,quantize:75,loopCount:2},Le=function(){function t(a,n){for(var o=0;o<n.length;o++){var s=n[o];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(a,s.key,s)}}return function(a,n,o){return n&&t(a.prototype,n),o&&t(a,o),a}}();function _e(t,a){if(!(t instanceof a))throw new TypeError("Cannot call a class as a function")}var Ae=function(){function t(a){_e(this,t),this.source=a,this.index=0}return Le(t,[{key:"hasNext",value:function(){return this.index<this.source.length}},{key:"peek",value:function(){return this.source.charAt(this.index)||""}},{key:"next",value:function(){return this.source.charAt(this.index++)||""}},{key:"forward",value:function(){for(;this.hasNext()&&this.match(/\s/);)this.index+=1}},{key:"match",value:function(n){return n instanceof RegExp?n.test(this.peek()):this.peek()===n}},{key:"expect",value:function(n){this.match(n)||this.throwUnexpectedToken(),this.index+=1}},{key:"scan",value:function(n){var o=this.source.substr(this.index),s=null;if(n instanceof RegExp){var d=n.exec(o);d&&d.index===0&&(s=d[0])}else o.substr(0,n.length)===n&&(s=n);return s&&(this.index+=s.length),s}},{key:"throwUnexpectedToken",value:function(){var n=this.peek()||"ILLEGAL";throw new SyntaxError("Unexpected token: "+n)}}]),t}(),Me=Ae,be=function(){function t(a,n){for(var o=0;o<n.length;o++){var s=n[o];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(a,s.key,s)}}return function(a,n,o){return n&&t(a.prototype,n),o&&t(a,o),a}}();function Pe(t,a){if(!(t instanceof a))throw new TypeError("Cannot call a class as a function")}var P=A,De=Me,Ne={c:0,d:2,e:4,f:5,g:7,a:9,b:11},Fe=function(){function t(a){Pe(this,t),this.scanner=new De(a)}return be(t,[{key:"parse",value:function(){var n=this,o=[];return this._readUntil(";",function(){o=o.concat(n.advance())}),o}},{key:"advance",value:function(){switch(this.scanner.peek()){case"c":case"d":case"e":case"f":case"g":case"a":case"b":return this.readNote();case"[":return this.readChord();case"r":return this.readRest();case"o":return this.readOctave();case">":return this.readOctaveShift(1);case"<":return this.readOctaveShift(-1);case"l":return this.readNoteLength();case"q":return this.readNoteQuantize();case"v":return this.readNoteVelocity();case"t":return this.readTempo();case"$":return this.readInfiniteLoop();case"/":return this.readLoop()}this.scanner.throwUnexpectedToken()}},{key:"readNote",value:function(){return{type:P.Note,noteNumbers:[this._readNoteNumber(0)],noteLength:this._readLength()}}},{key:"readChord",value:function(){var n=this;this.scanner.expect("[");var o=[],s=0;return this._readUntil("]",function(){switch(n.scanner.peek()){case"c":case"d":case"e":case"f":case"g":case"a":case"b":o.push(n._readNoteNumber(s));break;case">":n.scanner.next(),s+=12;break;case"<":n.scanner.next(),s-=12;break;default:n.scanner.throwUnexpectedToken()}}),this.scanner.expect("]"),{type:P.Note,noteNumbers:o,noteLength:this._readLength()}}},{key:"readRest",value:function(){return this.scanner.expect("r"),{type:P.Rest,noteLength:this._readLength()}}},{key:"readOctave",value:function(){return this.scanner.expect("o"),{type:P.Octave,value:this._readArgument(/\d+/)}}},{key:"readOctaveShift",value:function(n){return this.scanner.expect(/<|>/),{type:P.OctaveShift,direction:n|0,value:this._readArgument(/\d+/)}}},{key:"readNoteLength",value:function(){return this.scanner.expect("l"),{type:P.NoteLength,noteLength:this._readLength()}}},{key:"readNoteQuantize",value:function(){return this.scanner.expect("q"),{type:P.NoteQuantize,value:this._readArgument(/\d+/)}}},{key:"readNoteVelocity",value:function(){return this.scanner.expect("v"),{type:P.NoteVelocity,value:this._readArgument(/\d+/)}}},{key:"readTempo",value:function(){return this.scanner.expect("t"),{type:P.Tempo,value:this._readArgument(/\d+(\.\d+)?/)}}},{key:"readInfiniteLoop",value:function(){return this.scanner.expect("$"),{type:P.InfiniteLoop}}},{key:"readLoop",value:function(){var n=this;this.scanner.expect("/"),this.scanner.expect(":");var o={type:P.LoopBegin},s={type:P.LoopEnd},d=[];return d=d.concat(o),this._readUntil(/[|:]/,function(){d=d.concat(n.advance())}),d=d.concat(this._readLoopExit()),this.scanner.expect(":"),this.scanner.expect("/"),o.value=this._readArgument(/\d+/)||null,d=d.concat(s),d}},{key:"_readUntil",value:function(n,o){for(;this.scanner.hasNext()&&(this.scanner.forward(),!(!this.scanner.hasNext()||this.scanner.match(n)));)o()}},{key:"_readArgument",value:function(n){var o=this.scanner.scan(n);return o!==null?+o:null}},{key:"_readNoteNumber",value:function(n){var o=Ne[this.scanner.next()];return o+this._readAccidental()+n}},{key:"_readAccidental",value:function(){return this.scanner.match("+")?1*this.scanner.scan(/\++/).length:this.scanner.match("-")?-1*this.scanner.scan(/\-+/).length:0}},{key:"_readDot",value:function(){for(var n=(this.scanner.scan(/\.+/)||"").length,o=new Array(n),s=0;s<n;s++)o[s]=0;return o}},{key:"_readLength",value:function(){var n=[];n=n.concat(this._readArgument(/\d+/)),n=n.concat(this._readDot());var o=this._readTie();return o&&(n=n.concat(o)),n}},{key:"_readTie",value:function(){return this.scanner.forward(),this.scanner.match("^")?(this.scanner.next(),this._readLength()):null}},{key:"_readLoopExit",value:function(){var n=this,o=[];if(this.scanner.match("|")){this.scanner.next();var s={type:P.LoopExit};o=o.concat(s),this._readUntil(":",function(){o=o.concat(n.advance())})}return o}}]),t}(),we=Fe,xe=function(){function t(a,n){for(var o=0;o<n.length;o++){var s=n[o];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(a,s.key,s)}}return function(a,n,o){return n&&t(a.prototype,n),o&&t(a,o),a}}();function ke(t,a){if(!(t instanceof a))throw new TypeError("Cannot call a class as a function")}var M=A,F=q,Te=we,qe=typeof Symbol!="undefined"?Symbol.iterator:"@@iterator",Ie=function(){function t(a){ke(this,t),this.source=a,this._commands=new Te(a).parse(),this._commandIndex=0,this._processedTime=0,this._iterator=null,this._octave=F.octave,this._noteLength=[F.length],this._velocity=F.velocity,this._quantize=F.quantize,this._tempo=F.tempo,this._infiniteLoopIndex=-1,this._loopStack=[],this._done=!1}return xe(t,[{key:"hasNext",value:function(){return this._commandIndex<this._commands.length}},{key:"next",value:function(){if(this._done)return{done:!0,value:null};if(this._iterator){var n=this._iterator.next();if(!n.done)return n}var o=this._forward(!0);if(ae(o))this._iterator=this[o.type](o);else return this._done=!0,{done:!1,value:{type:"end",time:this._processedTime}};return this.next()}},{key:qe,value:function(){return this}},{key:"_forward",value:function(n){for(;this.hasNext()&&!ae(this._commands[this._commandIndex]);){var o=this._commands[this._commandIndex++];this[o.type](o)}return n&&!this.hasNext()&&this._infiniteLoopIndex!==-1?(this._commandIndex=this._infiniteLoopIndex,this._forward(!1)):this._commands[this._commandIndex++]||{}}},{key:"_calcDuration",value:function(n){var o=this;n[0]===null&&(n=this._noteLength.concat(n.slice(1)));var s=null,d=0;return n=n.map(function(m){switch(m){case null:m=s;break;case 0:m=d*=2;break;default:s=d=m;break}var y=m!==null?m:F.length;return 60/o._tempo*(4/y)}),n.reduce(function(m,y){return m+y},0)}},{key:"_calcNoteNumber",value:function(n){return n+this._octave*12+12}},{key:M.Note,value:function(n){var o=this,s="note",d=this._processedTime,m=this._calcDuration(n.noteLength),y=n.noteNumbers.map(function(b){return o._calcNoteNumber(b)}),k=this._quantize,D=this._velocity;return this._processedTime=this._processedTime+m,Ee(y.map(function(b){return{type:s,time:d,duration:m,noteNumber:b,velocity:D,quantize:k}}))}},{key:M.Rest,value:function(n){var o=this._calcDuration(n.noteLength);this._processedTime=this._processedTime+o}},{key:M.Octave,value:function(n){this._octave=n.value!==null?n.value:F.octave}},{key:M.OctaveShift,value:function(n){var o=n.value!==null?n.value:1;this._octave+=o*n.direction}},{key:M.NoteLength,value:function(n){var o=n.noteLength.map(function(s){return s!==null?s:F.length});this._noteLength=o}},{key:M.NoteVelocity,value:function(n){this._velocity=n.value!==null?n.value:F.velocity}},{key:M.NoteQuantize,value:function(n){this._quantize=n.value!==null?n.value:F.quantize}},{key:M.Tempo,value:function(n){this._tempo=n.value!==null?n.value:F.tempo}},{key:M.InfiniteLoop,value:function(){this._infiniteLoopIndex=this._commandIndex}},{key:M.LoopBegin,value:function(n){var o=n.value!==null?n.value:F.loopCount,s=this._commandIndex,d=-1;this._loopStack.push({loopCount:o,loopTopIndex:s,loopOutIndex:d})}},{key:M.LoopExit,value:function(){var n=this._loopStack[this._loopStack.length-1],o=this._commandIndex;n.loopCount<=1&&n.loopOutIndex!==-1&&(o=n.loopOutIndex),this._commandIndex=o}},{key:M.LoopEnd,value:function(){var n=this._loopStack[this._loopStack.length-1],o=this._commandIndex;n.loopOutIndex===-1&&(n.loopOutIndex=this._commandIndex),n.loopCount-=1,0<n.loopCount?o=n.loopTopIndex:this._loopStack.pop(),this._commandIndex=o}}]),t}();function Ee(t){var a=0;return{next:function(){return a<t.length?{done:!1,value:t[a++]}:{done:!0}}}}function ae(t){return t.type===M.Note||t.type===M.Rest}var Ce=Ie,He=Ce;let T,ie,W,oe,ue=!1;function Be(t=void 0){T=t==null?new(window.AudioContext||window.webkitAudioContext):t,se(),le()}function Re(){ue||(ue=!0,Ve())}function se(t=150){ie=t,W=60/ie}function le(t=8){oe=4/t}function X(t){const a=W*oe;return a>0?Math.ceil(t/a)*a:t}function Ve(){const t=T.createBufferSource();t.start=t.start||t.noteOn,t.start()}var R={};(function(t){var a=+Math.PI*2,n=16|0,o=1|0,s=Math.sin,d=Math.pow,m=Math.abs,y=1e-6,k=window.AudioContext||window.webkitAudioContext;t.SampleRate=0|0,t.Sec=0|0,t.SetSampleRate=function(e){t.SampleRate=e|0,t.Sec=e|0},t.SetSampleRate(ft()),t.Live=function(){var e={};return e._generate=function(r){var i=new te(r,t.DefaultModules),l=G(i.getSamplesLeft());return i.generate(l),l},e},t.Module={},t.G={};var D=t.stage={PhaseSpeed:0,PhaseSpeedMod:10,Generator:20,SampleMod:30,Volume:40};function b(e,r){return e.stage-r.stage}t.InitDefaultParams=ve;function ve(e,r){for(var i=0;i<r.length;i+=1){var l=r[i],c=e[l.name]||{};K(l.params,function(f,h){typeof c[h]=="undefined"&&(c[h]=f.D)}),e[l.name]=c}}t.Processor=te;function te(e,r){e=e||{},r=r||t.DefaultModules,typeof e=="function"?e=e():e=JSON.parse(JSON.stringify(e)),this.finished=!1,this.state={SampleRate:e.SampleRate||t.SampleRate},r=r.slice(),r.sort(b),this.modules=r,ve(e,r);for(var i=0;i<this.modules.length;i+=1){var l=this.modules[i];this.modules[i].setup(this.state,e[l.name])}}te.prototype={generate:function(e){for(var r=0|0;r<e.length;r+=1)e[r]=0;if(!this.finished){for(var i=this.state,l=e.length|0,r=0;r<this.modules.length;r+=1){var c=this.modules[r],f=c.process(i,e.subarray(0,l))|0;l=Math.min(l,f)}l<e.length&&(this.finished=!0);for(var r=l;r<e.length;r++)e[r]=0}},getSamplesLeft:function(){for(var e=0,r=0;r<this.state.envelopes.length;r+=1)e+=this.state.envelopes[r].N;return e===0&&(e=3*this.state.SampleRate),e}},t.Module.Frequency={name:"Frequency",params:{Start:{L:30,H:1800,D:440},Min:{L:30,H:1800,D:30},Max:{L:30,H:1800,D:1800},Slide:{L:-1,H:1,D:0},DeltaSlide:{L:-1,H:1,D:0},RepeatSpeed:{L:0,H:3,D:0},ChangeAmount:{L:-12,H:12,D:0},ChangeSpeed:{L:0,H:1,D:0}},stage:D.PhaseSpeed,setup:function(e,r){var i=e.SampleRate;e.phaseParams=r,e.phaseSpeed=r.Start*a/i,e.phaseSpeedMax=r.Max*a/i,e.phaseSpeedMin=r.Min*a/i,e.phaseSpeedMin=Math.min(e.phaseSpeedMin,e.phaseSpeed),e.phaseSpeedMax=Math.max(e.phaseSpeedMax,e.phaseSpeed),e.phaseSlide=1+d(r.Slide,3)*64/i,e.phaseDeltaSlide=d(r.DeltaSlide,3)/(i*1e3),e.repeatTime=0,e.repeatLimit=1/0,r.RepeatSpeed>0&&(e.repeatLimit=r.RepeatSpeed*i),e.arpeggiatorTime=0,e.arpeggiatorLimit=r.ChangeSpeed*i,r.ChangeAmount==0&&(e.arpeggiatorLimit=1/0),e.arpeggiatorMod=1+r.ChangeAmount/12},process:function(e,r){for(var i=+e.phaseSpeed,l=+e.phaseSpeedMin,c=+e.phaseSpeedMax,f=+e.phaseSlide,h=+e.phaseDeltaSlide,v=e.repeatTime,p=e.repeatLimit,g=e.arpeggiatorTime,L=e.arpeggiatorLimit,N=e.arpeggiatorMod,_=0;_<r.length;_++){if(f+=h,i*=f,i=i<l?l:i>c?c:i,v>p)return this.setup(e,e.phaseParams),_+this.process(e,r.subarray(_))-1;v++,g>L&&(i*=N,g=0,L=1/0),g++,r[_]+=i}return e.repeatTime=v,e.arpeggiatorTime=g,e.arpeggiatorLimit=L,e.phaseSpeed=i,e.phaseSlide=f,r.length}},t.Module.Vibrato={name:"Vibrato",params:{Depth:{L:0,H:1,D:0},DepthSlide:{L:-1,H:1,D:0},Frequency:{L:.01,H:48,D:0},FrequencySlide:{L:-1,H:1,D:0}},stage:D.PhaseSpeedMod,setup:function(e,r){var i=e.SampleRate;e.vibratoPhase=0,e.vibratoDepth=r.Depth,e.vibratoPhaseSpeed=r.Frequency*a/i,e.vibratoPhaseSpeedSlide=1+d(r.FrequencySlide,3)*3/i,e.vibratoDepthSlide=r.DepthSlide/i},process:function(e,r){var i=+e.vibratoPhase,l=+e.vibratoDepth,c=+e.vibratoPhaseSpeed,f=+e.vibratoPhaseSpeedSlide,h=+e.vibratoDepthSlide;if(l==0&&h<=0)return r.length;for(var v=0;v<r.length;v++)i+=c,i>a&&(i-=a),r[v]+=r[v]*s(i)*l,c*=f,l+=h,l=dt(l);return e.vibratoPhase=i,e.vibratoDepth=l,e.vibratoPhaseSpeed=c,r.length}},t.Module.Generator={name:"Generator",params:{Func:{C:t.G,D:"square"},A:{L:0,H:1,D:0},B:{L:0,H:1,D:0},ASlide:{L:-1,H:1,D:0},BSlide:{L:-1,H:1,D:0}},stage:D.Generator,setup:function(e,r){e.generatorPhase=0,typeof r.Func=="string"?e.generator=t.G[r.Func]:e.generator=r.Func,typeof e.generator=="object"&&(e.generator=e.generator.create()),J(typeof e.generator=="function","generator must be a function"),e.generatorA=r.A,e.generatorASlide=r.ASlide,e.generatorB=r.B,e.generatorBSlide=r.BSlide},process:function(e,r){return e.generator(e,r)}};var me=1<<16;t.Module.Guitar={name:"Guitar",params:{A:{L:0,H:1,D:1},B:{L:0,H:1,D:1},C:{L:0,H:1,D:1}},stage:D.Generator,setup:function(e,r){e.guitarA=r.A,e.guitarB=r.B,e.guitarC=r.C,e.guitarBuffer=G(me),e.guitarHead=0;for(var i=e.guitarBuffer,l=0;l<i.length;l++)i[l]=B()*2-1},process:function(e,r){for(var i=me,l=i-1,c=+e.guitarA,f=+e.guitarB,h=+e.guitarC,v=c+f+h,p=e.guitarHead,g=e.guitarBuffer,L=0;L<r.length;L++){var N=a/r[L]|0;N=N>i?i:N;var _=p-N+i&l;g[p]=(g[_-0+i&l]*c+g[_-1+i&l]*f+g[_-2+i&l]*h)/v,r[L]=g[p],p=p+1&l}return e.guitarHead=p,r.length}},t.Module.Filter={name:"Filter",params:{LP:{L:0,H:1,D:1},LPSlide:{L:-1,H:1,D:0},LPResonance:{L:0,H:1,D:0},HP:{L:0,H:1,D:0},HPSlide:{L:-1,H:1,D:0}},stage:D.SampleMod+0,setup:function(e,r){e.FilterEnabled=r.HP>y||r.LP<1-y,e.LPEnabled=r.LP<1-y,e.LP=d(r.LP,3)/10,e.LPSlide=1+r.LPSlide*100/e.SampleRate,e.LPPos=0,e.LPPosSlide=0,e.LPDamping=5/(1+d(r.LPResonance,2)*20)*(.01+r.LP),e.LPDamping=1-Math.min(e.LPDamping,.8),e.HP=d(r.HP,2)/10,e.HPPos=0,e.HPSlide=1+r.HPSlide*100/e.SampleRate},enabled:function(e){return e.FilterEnabled},process:function(e,r){if(!this.enabled(e))return r.length;for(var i=+e.LP,l=+e.LPPos,c=+e.LPPosSlide,f=+e.LPSlide,h=+e.LPDamping,v=+e.LPEnabled,p=+e.HP,g=+e.HPPos,L=+e.HPSlide,N=0;N<r.length;N++){(p>y||p<-y)&&(p*=L,p=p<y?y:p>.1?.1:p);var _=l;i*=f,i=i<0?i=0:i>.1?.1:i;var E=r[N];v?(c+=(E-l)*i,c*=h):(l=E,c=0),l+=c,g+=l-_,g*=1-p,r[N]=g}return e.LPPos=l,e.LPPosSlide=c,e.LP=i,e.HP=p,e.HPPos=g,r.length}};var ne=1<<10;t.Module.Phaser={name:"Phaser",params:{Offset:{L:-1,H:1,D:0},Sweep:{L:-1,H:1,D:0}},stage:D.SampleMod+1,setup:function(e,r){e.phaserBuffer=G(ne),e.phaserPos=0,e.phaserOffset=d(r.Offset,2)*(ne-4),e.phaserOffsetSlide=d(r.Sweep,3)*4e3/e.SampleRate},enabled:function(e){return m(e.phaserOffsetSlide)>y||m(e.phaserOffset)>y},process:function(e,r){if(!this.enabled(e))return r.length;for(var i=ne,l=i-1,c=e.phaserBuffer,f=e.phaserPos|0,h=+e.phaserOffset,v=+e.phaserOffsetSlide,p=0;p<r.length;p++){h+=v,h<0&&(h=-h,v=-v),h>l&&(h=l,v=0),c[f]=r[p];var g=f-(h|0)+i&l;r[p]+=c[g],f=f+1&l|0}return e.phaserPos=f,e.phaserOffset=h,r.length}},t.Module.Volume={name:"Volume",params:{Master:{L:0,H:1,D:.5},Attack:{L:.001,H:1,D:.01},Sustain:{L:0,H:2,D:.3},Punch:{L:0,H:3,D:1},Decay:{L:.001,H:2,D:1}},stage:D.Volume,setup:function(e,r){var i=e.SampleRate,l=r.Master,c=l*(1+r.Punch);e.envelopes=[{S:0,E:l,N:r.Attack*i|0},{S:c,E:l,N:r.Sustain*i|0},{S:l,E:0,N:r.Decay*i|0}];for(var f=0;f<e.envelopes.length;f+=1){var h=e.envelopes[f];h.G=(h.E-h.S)/h.N}},process:function(e,r){for(var i=0;e.envelopes.length>0&&i<r.length;){for(var l=e.envelopes[0],c=l.S,f=l.G,h=Math.min(r.length-i,l.N)|0,v=i+h|0;i<v;i+=1)r[i]*=c,c+=f,c=ht(c,0,10);l.S=c,l.N-=h,l.N<=0&&e.envelopes.shift()}return i}},t.DefaultModules=[t.Module.Frequency,t.Module.Vibrato,t.Module.Generator,t.Module.Filter,t.Module.Phaser,t.Module.Volume],t.DefaultModules.sort(b),t.EmptyParams=w;function w(){return K(t.Module,function(){return{}})}t._RemoveEmptyParams=x;function x(e){for(var r in e)ye(e[r]).length==0&&delete e[r]}t.Preset={Reset:function(){return w()},Coin:function(){var e=w();return e.Frequency.Start=u(880,660),e.Volume.Sustain=u(.1),e.Volume.Decay=u(.4,.1),e.Volume.Punch=u(.3,.3),u()<.5&&(e.Frequency.ChangeSpeed=u(.15,.1),e.Frequency.ChangeAmount=u(8,4)),x(e),e},Laser:function(){var e=w();return e.Generator.Func=O(["square","saw","sine"]),u()<.33?(e.Frequency.Start=u(880,440),e.Frequency.Min=u(.1),e.Frequency.Slide=u(.3,-.8)):(e.Frequency.Start=u(1200,440),e.Frequency.Min=e.Frequency.Start-u(880,440),e.Frequency.Min<110&&(e.Frequency.Min=110),e.Frequency.Slide=u(.3,-1)),u()<.5?(e.Generator.A=u(.5),e.Generator.ASlide=u(.2)):(e.Generator.A=u(.5,.4),e.Generator.ASlide=u(.7)),e.Volume.Sustain=u(.2,.1),e.Volume.Decay=u(.4),u()<.5&&(e.Volume.Punch=u(.3)),u()<.33&&(e.Phaser.Offset=u(.2),e.Phaser.Sweep=u(.2)),u()<.5&&(e.Filter.HP=u(.3)),x(e),e},Explosion:function(){var e=w();return e.Generator.Func="noise",u()<.5?(e.Frequency.Start=u(440,40),e.Frequency.Slide=u(.4,-.1)):(e.Frequency.Start=u(1600,220),e.Frequency.Slide=u(-.2,-.2)),u()<.2&&(e.Frequency.Slide=0),u()<.3&&(e.Frequency.RepeatSpeed=u(.5,.3)),e.Volume.Sustain=u(.3,.1),e.Volume.Decay=u(.5),e.Volume.Punch=u(.6,.2),u()<.5&&(e.Phaser.Offset=u(.9,-.3),e.Phaser.Sweep=u(-.3)),u()<.33&&(e.Frequency.ChangeSpeed=u(.3,.6),e.Frequency.ChangeAmount=u(24,-12)),x(e),e},Powerup:function(){var e=w();return u()<.5?e.Generator.Func="saw":e.Generator.A=u(.6),e.Frequency.Start=u(220,440),u()<.5?(e.Frequency.Slide=u(.5,.2),e.Frequency.RepeatSpeed=u(.4,.4)):(e.Frequency.Slide=u(.2,.05),u()<.5&&(e.Vibrato.Depth=u(.6,.1),e.Vibrato.Frequency=u(30,10))),e.Volume.Sustain=u(.4),e.Volume.Decay=u(.4,.1),x(e),e},Hit:function(){var e=w();return e.Generator.Func=O(["square","saw","noise"]),e.Generator.A=u(.6),e.Generator.ASlide=u(1,-.5),e.Frequency.Start=u(880,220),e.Frequency.Slide=-u(.4,.3),e.Volume.Sustain=u(.1),e.Volume.Decay=u(.2,.1),u()<.5&&(e.Filter.HP=u(.3)),x(e),e},Jump:function(){var e=w();return e.Generator.Func="square",e.Generator.A=u(.6),e.Frequency.Start=u(330,330),e.Frequency.Slide=u(.4,.2),e.Volume.Sustain=u(.3,.1),e.Volume.Decay=u(.2,.1),u()<.5&&(e.Filter.HP=u(.3)),u()<.3&&(e.Filter.LP=u(-.6,1)),x(e),e},Select:function(){var e=w();return e.Generator.Func=O(["square","saw"]),e.Generator.A=u(.6),e.Frequency.Start=u(660,220),e.Volume.Sustain=u(.1,.1),e.Volume.Decay=u(.2),e.Filter.HP=.2,x(e),e},Lucky:function(){var e=w();return K(e,function(r,i){var l=t.Module[i].params;K(l,function(c,f){if(c.C){var h=ye(c.C);r[f]=h[h.length*B()|0]}else r[f]=B()*(c.H-c.L)+c.L})}),e.Volume.Master=.4,e.Filter={},x(e),e},Synth:function(){var e=w();return e.Generator.Func=O(["square","saw"]),e.Frequency.Start=O([340,240,170]),e.Volume.Attack=u()>.6?u(.5):0,e.Volume.Sustain=u(1),e.Volume.Punch=u(1),e.Volume.Decay=u(.9)+.1,e.Generator.A=u(1),u()<.25&&(e.Filter.HP=u(1)),u()<.25&&(e.Filter.LP=u(1)),x(e),e},Tone:function(){var e=w();return e.Generator.Func="square",e.Frequency.Start=261.6,e.Volume.Sustain=.6441,x(e),e},Click:function(){var e=u()>.5?t.Preset.Hit():t.Preset.Explosion();return u()<.5&&(e.Frequency.Slide=-.5+u(1)),u()<.5&&(e.Volume.Sustain*=u(.4)+.2,e.Volume.Decay*=u(.4)+.2),e.Frequency.Start=u(1200,440),x(e),e}},t.G.unoise=I("sample = Math.random();"),t.G.sine=I("sample = Math.sin(phase);"),t.G.saw=I("sample = 2*(phase/TAU - ((phase/TAU + 0.5)|0));"),t.G.triangle=I("sample = Math.abs(4 * ((phase/TAU - 0.25)%1) - 2) - 1;"),t.G.square=I("var s = Math.sin(phase); sample = s > A ? 1.0 : s < A ? -1.0 : A;"),t.G.synth=I("sample = Math.sin(phase) + .5*Math.sin(phase/2) + .3*Math.sin(phase/4);"),t.G.noise=I("if(phase % TAU < 4){__noiseLast = Math.random() * 2 - 1;} sample = __noiseLast;"),t.G.string={create:function(){for(var e=1<<16,r=e-1,i=G(e),l=0;l<i.length;l++)i[l]=B()*2-1;var c=0;return function(f,h){for(var v=Math.PI*2,p=+f.generatorA,g=+f.generatorASlide,L=+f.generatorB,N=+f.generatorBSlide,_=i,E=0;E<h.length;E++){var vt=h[E],mt=v/vt|0;p+=g,L+=N,p=p<0?0:p>1?1:p,L=L<0?0:L>1?1:L;var re=c-mt+e&r,St=(_[re-0+e&r]*1+_[re-1+e&r]*p+_[re-2+e&r]*L)/(1+p+L);_[c]=St,h[E]=_[c],c=c+1&r}return f.generatorA=p,f.generatorB=L,h.length}}};function I(e){return new Function("$","block",`var TAU = Math.PI * 2;
var sample;
var phase = +$.generatorPhase,
	A = +$.generatorA, ASlide = +$.generatorASlide,
	B = +$.generatorB, BSlide = +$.generatorBSlide;

for(var i = 0; i < block.length; i++){
	var phaseSpeed = block[i];
	phase += phaseSpeed;
	if(phase > TAU){ phase -= TAU };
	A += ASlide; B += BSlide;
   A = A < 0 ? 0 : A > 1 ? 1 : A;
   B = B < 0 ? 0 : B > 1 ? 1 : B;
`+e+`	block[i] = sample;
}

$.generatorPhase = phase;
$.generatorA = A;
$.generatorB = B;
return block.length;
`)}t.CreateAudio=lt;function lt(e){typeof Float32Array!="undefined"&&J(e instanceof Float32Array,"data must be an Float32Array");var r=o*n>>3,i=t.SampleRate*r,l=pt(8+36+e.length*2),c=0;function f(v){for(var p=0;p<v.length;p+=1)l[c]=v.charCodeAt(p),c++}function h(v,p){p<=0||(l[c]=v&255,c++,h(v>>8,p-1))}return f("RIFF"),h(36+e.length*2,4),f("WAVEfmt "),h(16,4),h(1,2),h(o,2),h(t.SampleRate,4),h(i,4),h(r,2),h(n,2),f("data"),h(e.length*2,4),Se(l.subarray(c),e),new Audio("data:audio/wav;base64,"+ct(l))}t.DownloadAsFile=function(e){J(e instanceof Audio,"input must be an Audio object"),document.location.href=e.src},t.Util={},t.Util.CopyFToU8=Se;function Se(e,r){J(e.length/2==r.length,"the target buffer must be twice as large as the iinput");for(var i=0,l=0;l<r.length;l++){var c=+r[l],f=c*32767|0;f=f<-32768?-32768:32767<f?32767:f,f+=f<0?65536:0,e[i]=f&255,i++,e[i]=f>>8,i++}}function ct(e){for(var r=32768,i="",l=0;l<e.length;l+=r){var c=Math.min(l+r,e.length);i+=String.fromCharCode.apply(null,e.subarray(l,c))}return btoa(i)}function ft(){return typeof k!="undefined"?new k().sampleRate:44100}function J(e,r){if(!e)throw new Error(r)}function ht(e,r,i){return e=+e,r=+r,i=+i,e<r?+r:e>i?+i:+e}function dt(e){return e=+e,e<0?0:e>1?1:+e}function K(e,r){var i={};for(var l in e)e.hasOwnProperty(l)&&(i[l]=r(e[l],l));return i}function u(e,r){var i=B();return e!==void 0&&(i*=e),r!==void 0&&(i+=r),i}function O(e){return e[e.length*B()|0]}function ye(e){var r=[];for(var i in e)r.push(i);return r}t._createFloatArray=G;function G(e){if(typeof Float32Array=="undefined")for(var r=new Array(e),i=0;i<r.length;i++)r[i]=0;return new Float32Array(e)}function pt(e){if(typeof Uint8Array=="undefined")for(var r=new Array(e),i=0;i<r.length;i++)r[i]=0|0;return new Uint8Array(e)}var ge=Math.random;t.setRandomFunc=function(e){ge=e};function B(){return ge()}})(R={});class Oe{constructor(a=null){z(this,"x");z(this,"y");z(this,"z");z(this,"w");this.setSeed(a)}get(a=1,n){return n==null&&(n=a,a=0),this.next()/4294967295*(n-a)+a}getInt(a,n){n==null&&(n=a,a=0);const o=Math.floor(a),s=Math.floor(n);return s===o?o:this.next()%(s-o)+o}getPlusOrMinus(){return this.getInt(2)*2-1}select(a){return a[this.getInt(a.length)]}setSeed(a,n=123456789,o=362436069,s=521288629,d=32){this.w=a!=null?a>>>0:Math.floor(Math.random()*4294967295)>>>0,this.x=n>>>0,this.y=o>>>0,this.z=s>>>0;for(let m=0;m<d;m++)this.next();return this}getState(){return{x:this.x,y:this.y,z:this.z,w:this.w}}next(){const a=this.x^this.x<<11;return this.x=this.y,this.y=this.z,this.z=this.w,this.w=(this.w^this.w>>>19^(a^a>>>8))>>>0,this.w}}const ce=new Oe;function Ge(t,a){let n=[];for(let o=0;o<t;o++)n.push(a(o));return n}const ze={coin:"Coin",laser:"Laser",explosion:"Explosion",powerUp:"PowerUp",hit:"Hit",jump:"Jump",select:"Select",synth:"Synth",tone:"Tone",click:"Click",random:"Lucky"};let Y,fe;function Ue(){fe=R.Live(),Y=[],R.setRandomFunc(()=>ce.get())}function Qe(t){Xe(t)}function Je(){const t=T.currentTime;Y.forEach(a=>{Ye(a,t)})}function Ke(t,a,n=2,o=.05,s=void 0,d=1,m=1){const y=Ge(n,D=>{ce.setSeed(a+D*1063);const b=R.Preset[ze[t]]();return s!=null&&b.Frequency.Start!=null&&(b.Frequency.Start=s),b.Volume.Attack!=null&&(b.Volume.Attack*=d),b.Volume.Sustain!=null&&(b.Volume.Sustain*=m),b}),k=he({type:t,params:y,volume:o});return Y.push(k),k}function We(t,a){t.gainNode.gain.value=a}function Xe(t){t.isPlaying=!0}function Ye(t,a){if(!t.isPlaying)return;t.isPlaying=!1;const n=X(a);(t.playedTime==null||n>t.playedTime)&&(Z(t,n),t.playedTime=n)}function Z(t,a,n=void 0){t.bufferSourceNodes=[],t.buffers.forEach(o=>{const s=T.createBufferSource();if(s.buffer=o,n!=null&&s.playbackRate!=null){const d=Math.pow(2,1/12);s.playbackRate.value=Math.pow(d,n)}s.start=s.start||s.noteOn,s.connect(t.gainNode),s.start(a),t.bufferSourceNodes.push(s)})}function j(t,a=void 0){t.bufferSourceNodes!=null&&(t.bufferSourceNodes.forEach(n=>{a==null?n.stop():n.stop(a)}),t.bufferSourceNodes=void 0)}function he(t){const a=t.type,n=t.params,o=t.volume,s=n.map(m=>{const y=fe._generate(m),k=T.createBuffer(1,y.length,R.SampleRate);var D=k.getChannelData(0);return D.set(y),k}),d=T.createGain();return d.gain.value=o,d.connect(T.destination),{type:a,params:n,volume:o,buffers:s,bufferSourceNodes:void 0,gainNode:d,isPlaying:!1,playedTime:void 0}}function Ze(t,a,n,o,s){return{mml:t,sequence:a,soundEffect:n,isDrum:o,noteIndex:0,endStep:-1,visualizer:s}}function je(t,a){return{mml:t.mml,sequence:a(t.mml,V),soundEffect:he(t.soundEffect),isDrum:t.isDrum,noteIndex:0,endStep:-1}}let U,V,C,$,H,ee=!1;function $e(t,a){U=t,V=a,C=0,$=W/2,H=X(T.currentTime)-$,U.forEach(n=>{n.noteIndex=0}),ee=!0}function et(){ee=!1,U.forEach(t=>{j(t.soundEffect)})}function tt(){if(!ee)return;const t=T.currentTime;t<H||(H+=$,H<t&&(H=X(t)),U.forEach(a=>{nt(a,H)}),C++,C>=V&&(C=0))}function nt(t,a){const n=t.sequence.notes[t.noteIndex];n!=null&&((t.soundEffect.type==="synth"||t.soundEffect.type==="tone")&&t.endStep===C&&j(t.soundEffect,a),n.quantizedStartStep===C&&((t.soundEffect.type==="synth"||t.soundEffect.type==="tone")&&j(t.soundEffect),t.isDrum?Z(t.soundEffect,a):Z(t.soundEffect,a,n.pitch-69),t.visualizer!=null&&t.visualizer.redraw(n),t.endStep=n.quantizedEndStep,t.endStep>=V&&(t.endStep-=V),t.noteIndex++,t.noteIndex>=t.sequence.notes.length&&(t.noteIndex=0)))}const de=.125;let pe,Q;function rt(t,a=.1){const n=t.parts.map(o=>{const s=je(o,st);return We(s.soundEffect,s.soundEffect.volume*a/.2),Ze(s.mml,s.sequence,s.soundEffect,s.isDrum)});$e(n,t.notesStepsCount)}function at(){et()}function it(t,a=void 0,n=2,o=.1,s=void 0){const d=`${t}_${a}_${n}_${o}_${s}`;Q[d]==null&&(Q[d]=Ke(t,a==null?pe:a,n,o,s)),Qe(Q[d])}function ot(){tt(),Je()}function ut(t=1,a=void 0){pe=t,Be(a),Ue(),Q={}}function st(t,a){const n=[],o=new He(t);for(let s of o)if(s.type==="note"){let d=Math.floor(s.time+s.duration/de);d>=a&&(d-=a),n.push({pitch:s.noteNumber,quantizedStartStep:Math.floor(s.time/de),endStep:d})}return{notes:n}}S.init=ut,S.playMml=rt,S.playSoundEffect=it,S.setQuantize=le,S.setTempo=se,S.startAudio=Re,S.stopMml=at,S.update=ot,Object.defineProperty(S,"__esModule",{value:!0}),S[Symbol.toStringTag]="Module"});
