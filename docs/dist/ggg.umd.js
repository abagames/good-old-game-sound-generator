var Tt=Object.defineProperty;var It=(y,x,q)=>x in y?Tt(y,x,{enumerable:!0,configurable:!0,writable:!0,value:q}):y[x]=q;var U=(y,x,q)=>(It(y,typeof x!="symbol"?x+"":x,q),q);(function(y,x){typeof exports=="object"&&typeof module!="undefined"?x(exports):typeof define=="function"&&define.amd?define(["exports"],x):(y=typeof globalThis!="undefined"?globalThis:y||self,x(y.ggg={}))})(this,function(y){"use strict";var x={Note:"Note",Rest:"Rest",Octave:"Octave",OctaveShift:"OctaveShift",NoteLength:"NoteLength",NoteVelocity:"NoteVelocity",NoteQuantize:"NoteQuantize",Tempo:"Tempo",InfiniteLoop:"InfiniteLoop",LoopBegin:"LoopBegin",LoopExit:"LoopExit",LoopEnd:"LoopEnd"},q={tempo:120,octave:4,length:4,velocity:100,quantize:75,loopCount:2},Ne=function(){function t(n,r){for(var i=0;i<r.length;i++){var u=r[i];u.enumerable=u.enumerable||!1,u.configurable=!0,"value"in u&&(u.writable=!0),Object.defineProperty(n,u.key,u)}}return function(n,r,i){return r&&t(n.prototype,r),i&&t(n,i),n}}();function we(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")}var De=function(){function t(n){we(this,t),this.source=n,this.index=0}return Ne(t,[{key:"hasNext",value:function(){return this.index<this.source.length}},{key:"peek",value:function(){return this.source.charAt(this.index)||""}},{key:"next",value:function(){return this.source.charAt(this.index++)||""}},{key:"forward",value:function(){for(;this.hasNext()&&this.match(/\s/);)this.index+=1}},{key:"match",value:function(r){return r instanceof RegExp?r.test(this.peek()):this.peek()===r}},{key:"expect",value:function(r){this.match(r)||this.throwUnexpectedToken(),this.index+=1}},{key:"scan",value:function(r){var i=this.source.substr(this.index),u=null;if(r instanceof RegExp){var c=r.exec(i);c&&c.index===0&&(u=c[0])}else i.substr(0,r.length)===r&&(u=r);return u&&(this.index+=u.length),u}},{key:"throwUnexpectedToken",value:function(){var r=this.peek()||"ILLEGAL";throw new SyntaxError("Unexpected token: "+r)}}]),t}(),Fe=De,Te=function(){function t(n,r){for(var i=0;i<r.length;i++){var u=r[i];u.enumerable=u.enumerable||!1,u.configurable=!0,"value"in u&&(u.writable=!0),Object.defineProperty(n,u.key,u)}}return function(n,r,i){return r&&t(n.prototype,r),i&&t(n,i),n}}();function Ie(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")}var P=x,qe=Fe,ke={c:0,d:2,e:4,f:5,g:7,a:9,b:11},Ee=function(){function t(n){Ie(this,t),this.scanner=new qe(n)}return Te(t,[{key:"parse",value:function(){var r=this,i=[];return this._readUntil(";",function(){i=i.concat(r.advance())}),i}},{key:"advance",value:function(){switch(this.scanner.peek()){case"c":case"d":case"e":case"f":case"g":case"a":case"b":return this.readNote();case"[":return this.readChord();case"r":return this.readRest();case"o":return this.readOctave();case">":return this.readOctaveShift(1);case"<":return this.readOctaveShift(-1);case"l":return this.readNoteLength();case"q":return this.readNoteQuantize();case"v":return this.readNoteVelocity();case"t":return this.readTempo();case"$":return this.readInfiniteLoop();case"/":return this.readLoop()}this.scanner.throwUnexpectedToken()}},{key:"readNote",value:function(){return{type:P.Note,noteNumbers:[this._readNoteNumber(0)],noteLength:this._readLength()}}},{key:"readChord",value:function(){var r=this;this.scanner.expect("[");var i=[],u=0;return this._readUntil("]",function(){switch(r.scanner.peek()){case"c":case"d":case"e":case"f":case"g":case"a":case"b":i.push(r._readNoteNumber(u));break;case">":r.scanner.next(),u+=12;break;case"<":r.scanner.next(),u-=12;break;default:r.scanner.throwUnexpectedToken()}}),this.scanner.expect("]"),{type:P.Note,noteNumbers:i,noteLength:this._readLength()}}},{key:"readRest",value:function(){return this.scanner.expect("r"),{type:P.Rest,noteLength:this._readLength()}}},{key:"readOctave",value:function(){return this.scanner.expect("o"),{type:P.Octave,value:this._readArgument(/\d+/)}}},{key:"readOctaveShift",value:function(r){return this.scanner.expect(/<|>/),{type:P.OctaveShift,direction:r|0,value:this._readArgument(/\d+/)}}},{key:"readNoteLength",value:function(){return this.scanner.expect("l"),{type:P.NoteLength,noteLength:this._readLength()}}},{key:"readNoteQuantize",value:function(){return this.scanner.expect("q"),{type:P.NoteQuantize,value:this._readArgument(/\d+/)}}},{key:"readNoteVelocity",value:function(){return this.scanner.expect("v"),{type:P.NoteVelocity,value:this._readArgument(/\d+/)}}},{key:"readTempo",value:function(){return this.scanner.expect("t"),{type:P.Tempo,value:this._readArgument(/\d+(\.\d+)?/)}}},{key:"readInfiniteLoop",value:function(){return this.scanner.expect("$"),{type:P.InfiniteLoop}}},{key:"readLoop",value:function(){var r=this;this.scanner.expect("/"),this.scanner.expect(":");var i={type:P.LoopBegin},u={type:P.LoopEnd},c=[];return c=c.concat(i),this._readUntil(/[|:]/,function(){c=c.concat(r.advance())}),c=c.concat(this._readLoopExit()),this.scanner.expect(":"),this.scanner.expect("/"),i.value=this._readArgument(/\d+/)||null,c=c.concat(u),c}},{key:"_readUntil",value:function(r,i){for(;this.scanner.hasNext()&&(this.scanner.forward(),!(!this.scanner.hasNext()||this.scanner.match(r)));)i()}},{key:"_readArgument",value:function(r){var i=this.scanner.scan(r);return i!==null?+i:null}},{key:"_readNoteNumber",value:function(r){var i=ke[this.scanner.next()];return i+this._readAccidental()+r}},{key:"_readAccidental",value:function(){return this.scanner.match("+")?1*this.scanner.scan(/\++/).length:this.scanner.match("-")?-1*this.scanner.scan(/\-+/).length:0}},{key:"_readDot",value:function(){for(var r=(this.scanner.scan(/\.+/)||"").length,i=new Array(r),u=0;u<r;u++)i[u]=0;return i}},{key:"_readLength",value:function(){var r=[];r=r.concat(this._readArgument(/\d+/)),r=r.concat(this._readDot());var i=this._readTie();return i&&(r=r.concat(i)),r}},{key:"_readTie",value:function(){return this.scanner.forward(),this.scanner.match("^")?(this.scanner.next(),this._readLength()):null}},{key:"_readLoopExit",value:function(){var r=this,i=[];if(this.scanner.match("|")){this.scanner.next();var u={type:P.LoopExit};i=i.concat(u),this._readUntil(":",function(){i=i.concat(r.advance())})}return i}}]),t}(),Ce=Ee,He=function(){function t(n,r){for(var i=0;i<r.length;i++){var u=r[i];u.enumerable=u.enumerable||!1,u.configurable=!0,"value"in u&&(u.writable=!0),Object.defineProperty(n,u.key,u)}}return function(n,r,i){return r&&t(n.prototype,r),i&&t(n,i),n}}();function Re(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")}var b=x,w=q,Be=Ce,Ve=typeof Symbol!="undefined"?Symbol.iterator:"@@iterator",Ge=function(){function t(n){Re(this,t),this.source=n,this._commands=new Be(n).parse(),this._commandIndex=0,this._processedTime=0,this._iterator=null,this._octave=w.octave,this._noteLength=[w.length],this._velocity=w.velocity,this._quantize=w.quantize,this._tempo=w.tempo,this._infiniteLoopIndex=-1,this._loopStack=[],this._done=!1}return He(t,[{key:"hasNext",value:function(){return this._commandIndex<this._commands.length}},{key:"next",value:function(){if(this._done)return{done:!0,value:null};if(this._iterator){var r=this._iterator.next();if(!r.done)return r}var i=this._forward(!0);if(ae(i))this._iterator=this[i.type](i);else return this._done=!0,{done:!1,value:{type:"end",time:this._processedTime}};return this.next()}},{key:Ve,value:function(){return this}},{key:"_forward",value:function(r){for(;this.hasNext()&&!ae(this._commands[this._commandIndex]);){var i=this._commands[this._commandIndex++];this[i.type](i)}return r&&!this.hasNext()&&this._infiniteLoopIndex!==-1?(this._commandIndex=this._infiniteLoopIndex,this._forward(!1)):this._commands[this._commandIndex++]||{}}},{key:"_calcDuration",value:function(r){var i=this;r[0]===null&&(r=this._noteLength.concat(r.slice(1)));var u=null,c=0;return r=r.map(function(m){switch(m){case null:m=u;break;case 0:m=c*=2;break;default:u=c=m;break}var v=m!==null?m:w.length;return 60/i._tempo*(4/v)}),r.reduce(function(m,v){return m+v},0)}},{key:"_calcNoteNumber",value:function(r){return r+this._octave*12+12}},{key:b.Note,value:function(r){var i=this,u="note",c=this._processedTime,m=this._calcDuration(r.noteLength),v=r.noteNumbers.map(function(D){return i._calcNoteNumber(D)}),g=this._quantize,L=this._velocity;return this._processedTime=this._processedTime+m,Oe(v.map(function(D){return{type:u,time:c,duration:m,noteNumber:D,velocity:L,quantize:g}}))}},{key:b.Rest,value:function(r){var i=this._calcDuration(r.noteLength);this._processedTime=this._processedTime+i}},{key:b.Octave,value:function(r){this._octave=r.value!==null?r.value:w.octave}},{key:b.OctaveShift,value:function(r){var i=r.value!==null?r.value:1;this._octave+=i*r.direction}},{key:b.NoteLength,value:function(r){var i=r.noteLength.map(function(u){return u!==null?u:w.length});this._noteLength=i}},{key:b.NoteVelocity,value:function(r){this._velocity=r.value!==null?r.value:w.velocity}},{key:b.NoteQuantize,value:function(r){this._quantize=r.value!==null?r.value:w.quantize}},{key:b.Tempo,value:function(r){this._tempo=r.value!==null?r.value:w.tempo}},{key:b.InfiniteLoop,value:function(){this._infiniteLoopIndex=this._commandIndex}},{key:b.LoopBegin,value:function(r){var i=r.value!==null?r.value:w.loopCount,u=this._commandIndex,c=-1;this._loopStack.push({loopCount:i,loopTopIndex:u,loopOutIndex:c})}},{key:b.LoopExit,value:function(){var r=this._loopStack[this._loopStack.length-1],i=this._commandIndex;r.loopCount<=1&&r.loopOutIndex!==-1&&(i=r.loopOutIndex),this._commandIndex=i}},{key:b.LoopEnd,value:function(){var r=this._loopStack[this._loopStack.length-1],i=this._commandIndex;r.loopOutIndex===-1&&(r.loopOutIndex=this._commandIndex),r.loopCount-=1,0<r.loopCount?i=r.loopTopIndex:this._loopStack.pop(),this._commandIndex=i}}]),t}();function Oe(t){var n=0;return{next:function(){return n<t.length?{done:!1,value:t[n++]}:{done:!0}}}}function ae(t){return t.type===b.Note||t.type===b.Rest}var ze=Ge,ie=ze,G={};(function(t){var n=+Math.PI*2,r=16|0,i=1|0,u=Math.sin,c=Math.pow,m=Math.abs,v=1e-6,g=window.AudioContext||window.webkitAudioContext;t.SampleRate=0|0,t.Sec=0|0,t.SetSampleRate=function(e){t.SampleRate=e|0,t.Sec=e|0},t.SetSampleRate(xt()),t.Live=function(){var e={};return e._generate=function(a){var o=new C(a,t.DefaultModules),l=z(o.getSamplesLeft());return o.generate(l),l},e},t.Module={},t.G={};var L=t.stage={PhaseSpeed:0,PhaseSpeedMod:10,Generator:20,SampleMod:30,Volume:40};function D(e,a){return e.stage-a.stage}t.InitDefaultParams=E;function E(e,a){for(var o=0;o<a.length;o+=1){var l=a[o],f=e[l.name]||{};K(l.params,function(h,d){typeof f[d]=="undefined"&&(f[d]=h.D)}),e[l.name]=f}}t.Processor=C;function C(e,a){e=e||{},a=a||t.DefaultModules,typeof e=="function"?e=e():e=JSON.parse(JSON.stringify(e)),this.finished=!1,this.state={SampleRate:e.SampleRate||t.SampleRate},a=a.slice(),a.sort(D),this.modules=a,E(e,a);for(var o=0;o<this.modules.length;o+=1){var l=this.modules[o];this.modules[o].setup(this.state,e[l.name])}}C.prototype={generate:function(e){for(var a=0|0;a<e.length;a+=1)e[a]=0;if(!this.finished){for(var o=this.state,l=e.length|0,a=0;a<this.modules.length;a+=1){var f=this.modules[a],h=f.process(o,e.subarray(0,l))|0;l=Math.min(l,h)}l<e.length&&(this.finished=!0);for(var a=l;a<e.length;a++)e[a]=0}},getSamplesLeft:function(){for(var e=0,a=0;a<this.state.envelopes.length;a+=1)e+=this.state.envelopes[a].N;return e===0&&(e=3*this.state.SampleRate),e}},t.Module.Frequency={name:"Frequency",params:{Start:{L:30,H:1800,D:440},Min:{L:30,H:1800,D:30},Max:{L:30,H:1800,D:1800},Slide:{L:-1,H:1,D:0},DeltaSlide:{L:-1,H:1,D:0},RepeatSpeed:{L:0,H:3,D:0},ChangeAmount:{L:-12,H:12,D:0},ChangeSpeed:{L:0,H:1,D:0}},stage:L.PhaseSpeed,setup:function(e,a){var o=e.SampleRate;e.phaseParams=a,e.phaseSpeed=a.Start*n/o,e.phaseSpeedMax=a.Max*n/o,e.phaseSpeedMin=a.Min*n/o,e.phaseSpeedMin=Math.min(e.phaseSpeedMin,e.phaseSpeed),e.phaseSpeedMax=Math.max(e.phaseSpeedMax,e.phaseSpeed),e.phaseSlide=1+c(a.Slide,3)*64/o,e.phaseDeltaSlide=c(a.DeltaSlide,3)/(o*1e3),e.repeatTime=0,e.repeatLimit=1/0,a.RepeatSpeed>0&&(e.repeatLimit=a.RepeatSpeed*o),e.arpeggiatorTime=0,e.arpeggiatorLimit=a.ChangeSpeed*o,a.ChangeAmount==0&&(e.arpeggiatorLimit=1/0),e.arpeggiatorMod=1+a.ChangeAmount/12},process:function(e,a){for(var o=+e.phaseSpeed,l=+e.phaseSpeedMin,f=+e.phaseSpeedMax,h=+e.phaseSlide,d=+e.phaseDeltaSlide,S=e.repeatTime,p=e.repeatLimit,_=e.arpeggiatorTime,A=e.arpeggiatorLimit,N=e.arpeggiatorMod,M=0;M<a.length;M++){if(h+=d,o*=h,o=o<l?l:o>f?f:o,S>p)return this.setup(e,e.phaseParams),M+this.process(e,a.subarray(M))-1;S++,_>A&&(o*=N,_=0,A=1/0),_++,a[M]+=o}return e.repeatTime=S,e.arpeggiatorTime=_,e.arpeggiatorLimit=A,e.phaseSpeed=o,e.phaseSlide=h,a.length}},t.Module.Vibrato={name:"Vibrato",params:{Depth:{L:0,H:1,D:0},DepthSlide:{L:-1,H:1,D:0},Frequency:{L:.01,H:48,D:0},FrequencySlide:{L:-1,H:1,D:0}},stage:L.PhaseSpeedMod,setup:function(e,a){var o=e.SampleRate;e.vibratoPhase=0,e.vibratoDepth=a.Depth,e.vibratoPhaseSpeed=a.Frequency*n/o,e.vibratoPhaseSpeedSlide=1+c(a.FrequencySlide,3)*3/o,e.vibratoDepthSlide=a.DepthSlide/o},process:function(e,a){var o=+e.vibratoPhase,l=+e.vibratoDepth,f=+e.vibratoPhaseSpeed,h=+e.vibratoPhaseSpeedSlide,d=+e.vibratoDepthSlide;if(l==0&&d<=0)return a.length;for(var S=0;S<a.length;S++)o+=f,o>n&&(o-=n),a[S]+=a[S]*u(o)*l,f*=h,l+=d,l=Pt(l);return e.vibratoPhase=o,e.vibratoDepth=l,e.vibratoPhaseSpeed=f,a.length}},t.Module.Generator={name:"Generator",params:{Func:{C:t.G,D:"square"},A:{L:0,H:1,D:0},B:{L:0,H:1,D:0},ASlide:{L:-1,H:1,D:0},BSlide:{L:-1,H:1,D:0}},stage:L.Generator,setup:function(e,a){e.generatorPhase=0,typeof a.Func=="string"?e.generator=t.G[a.Func]:e.generator=a.Func,typeof e.generator=="object"&&(e.generator=e.generator.create()),J(typeof e.generator=="function","generator must be a function"),e.generatorA=a.A,e.generatorASlide=a.ASlide,e.generatorB=a.B,e.generatorBSlide=a.BSlide},process:function(e,a){return e.generator(e,a)}};var Me=1<<16;t.Module.Guitar={name:"Guitar",params:{A:{L:0,H:1,D:1},B:{L:0,H:1,D:1},C:{L:0,H:1,D:1}},stage:L.Generator,setup:function(e,a){e.guitarA=a.A,e.guitarB=a.B,e.guitarC=a.C,e.guitarBuffer=z(Me),e.guitarHead=0;for(var o=e.guitarBuffer,l=0;l<o.length;l++)o[l]=V()*2-1},process:function(e,a){for(var o=Me,l=o-1,f=+e.guitarA,h=+e.guitarB,d=+e.guitarC,S=f+h+d,p=e.guitarHead,_=e.guitarBuffer,A=0;A<a.length;A++){var N=n/a[A]|0;N=N>o?o:N;var M=p-N+o&l;_[p]=(_[M-0+o&l]*f+_[M-1+o&l]*h+_[M-2+o&l]*d)/S,a[A]=_[p],p=p+1&l}return e.guitarHead=p,a.length}},t.Module.Filter={name:"Filter",params:{LP:{L:0,H:1,D:1},LPSlide:{L:-1,H:1,D:0},LPResonance:{L:0,H:1,D:0},HP:{L:0,H:1,D:0},HPSlide:{L:-1,H:1,D:0}},stage:L.SampleMod+0,setup:function(e,a){e.FilterEnabled=a.HP>v||a.LP<1-v,e.LPEnabled=a.LP<1-v,e.LP=c(a.LP,3)/10,e.LPSlide=1+a.LPSlide*100/e.SampleRate,e.LPPos=0,e.LPPosSlide=0,e.LPDamping=5/(1+c(a.LPResonance,2)*20)*(.01+a.LP),e.LPDamping=1-Math.min(e.LPDamping,.8),e.HP=c(a.HP,2)/10,e.HPPos=0,e.HPSlide=1+a.HPSlide*100/e.SampleRate},enabled:function(e){return e.FilterEnabled},process:function(e,a){if(!this.enabled(e))return a.length;for(var o=+e.LP,l=+e.LPPos,f=+e.LPPosSlide,h=+e.LPSlide,d=+e.LPDamping,S=+e.LPEnabled,p=+e.HP,_=+e.HPPos,A=+e.HPSlide,N=0;N<a.length;N++){(p>v||p<-v)&&(p*=A,p=p<v?v:p>.1?.1:p);var M=l;o*=h,o=o<0?o=0:o>.1?.1:o;var R=a[N];S?(f+=(R-l)*o,f*=d):(l=R,f=0),l+=f,_+=l-M,_*=1-p,a[N]=_}return e.LPPos=l,e.LPPosSlide=f,e.LP=o,e.HP=p,e.HPPos=_,a.length}};var ne=1<<10;t.Module.Phaser={name:"Phaser",params:{Offset:{L:-1,H:1,D:0},Sweep:{L:-1,H:1,D:0}},stage:L.SampleMod+1,setup:function(e,a){e.phaserBuffer=z(ne),e.phaserPos=0,e.phaserOffset=c(a.Offset,2)*(ne-4),e.phaserOffsetSlide=c(a.Sweep,3)*4e3/e.SampleRate},enabled:function(e){return m(e.phaserOffsetSlide)>v||m(e.phaserOffset)>v},process:function(e,a){if(!this.enabled(e))return a.length;for(var o=ne,l=o-1,f=e.phaserBuffer,h=e.phaserPos|0,d=+e.phaserOffset,S=+e.phaserOffsetSlide,p=0;p<a.length;p++){d+=S,d<0&&(d=-d,S=-S),d>l&&(d=l,S=0),f[h]=a[p];var _=h-(d|0)+o&l;a[p]+=f[_],h=h+1&l|0}return e.phaserPos=h,e.phaserOffset=d,a.length}},t.Module.Volume={name:"Volume",params:{Master:{L:0,H:1,D:.5},Attack:{L:.001,H:1,D:.01},Sustain:{L:0,H:2,D:.3},Punch:{L:0,H:3,D:1},Decay:{L:.001,H:2,D:1}},stage:L.Volume,setup:function(e,a){var o=e.SampleRate,l=a.Master,f=l*(1+a.Punch);e.envelopes=[{S:0,E:l,N:a.Attack*o|0},{S:f,E:l,N:a.Sustain*o|0},{S:l,E:0,N:a.Decay*o|0}];for(var h=0;h<e.envelopes.length;h+=1){var d=e.envelopes[h];d.G=(d.E-d.S)/d.N}},process:function(e,a){for(var o=0;e.envelopes.length>0&&o<a.length;){for(var l=e.envelopes[0],f=l.S,h=l.G,d=Math.min(a.length-o,l.N)|0,S=o+d|0;o<S;o+=1)a[o]*=f,f+=h,f=bt(f,0,10);l.S=f,l.N-=d,l.N<=0&&e.envelopes.shift()}return o}},t.DefaultModules=[t.Module.Frequency,t.Module.Vibrato,t.Module.Generator,t.Module.Filter,t.Module.Phaser,t.Module.Volume],t.DefaultModules.sort(D),t.EmptyParams=F;function F(){return K(t.Module,function(){return{}})}t._RemoveEmptyParams=T;function T(e){for(var a in e)be(e[a]).length==0&&delete e[a]}t.Preset={Reset:function(){return F()},Coin:function(){var e=F();return e.Frequency.Start=s(880,660),e.Volume.Sustain=s(.1),e.Volume.Decay=s(.4,.1),e.Volume.Punch=s(.3,.3),s()<.5&&(e.Frequency.ChangeSpeed=s(.15,.1),e.Frequency.ChangeAmount=s(8,4)),T(e),e},Laser:function(){var e=F();return e.Generator.Func=O(["square","saw","sine"]),s()<.33?(e.Frequency.Start=s(880,440),e.Frequency.Min=s(.1),e.Frequency.Slide=s(.3,-.8)):(e.Frequency.Start=s(1200,440),e.Frequency.Min=e.Frequency.Start-s(880,440),e.Frequency.Min<110&&(e.Frequency.Min=110),e.Frequency.Slide=s(.3,-1)),s()<.5?(e.Generator.A=s(.5),e.Generator.ASlide=s(.2)):(e.Generator.A=s(.5,.4),e.Generator.ASlide=s(.7)),e.Volume.Sustain=s(.2,.1),e.Volume.Decay=s(.4),s()<.5&&(e.Volume.Punch=s(.3)),s()<.33&&(e.Phaser.Offset=s(.2),e.Phaser.Sweep=s(.2)),s()<.5&&(e.Filter.HP=s(.3)),T(e),e},Explosion:function(){var e=F();return e.Generator.Func="noise",s()<.5?(e.Frequency.Start=s(440,40),e.Frequency.Slide=s(.4,-.1)):(e.Frequency.Start=s(1600,220),e.Frequency.Slide=s(-.2,-.2)),s()<.2&&(e.Frequency.Slide=0),s()<.3&&(e.Frequency.RepeatSpeed=s(.5,.3)),e.Volume.Sustain=s(.3,.1),e.Volume.Decay=s(.5),e.Volume.Punch=s(.6,.2),s()<.5&&(e.Phaser.Offset=s(.9,-.3),e.Phaser.Sweep=s(-.3)),s()<.33&&(e.Frequency.ChangeSpeed=s(.3,.6),e.Frequency.ChangeAmount=s(24,-12)),T(e),e},Powerup:function(){var e=F();return s()<.5?e.Generator.Func="saw":e.Generator.A=s(.6),e.Frequency.Start=s(220,440),s()<.5?(e.Frequency.Slide=s(.5,.2),e.Frequency.RepeatSpeed=s(.4,.4)):(e.Frequency.Slide=s(.2,.05),s()<.5&&(e.Vibrato.Depth=s(.6,.1),e.Vibrato.Frequency=s(30,10))),e.Volume.Sustain=s(.4),e.Volume.Decay=s(.4,.1),T(e),e},Hit:function(){var e=F();return e.Generator.Func=O(["square","saw","noise"]),e.Generator.A=s(.6),e.Generator.ASlide=s(1,-.5),e.Frequency.Start=s(880,220),e.Frequency.Slide=-s(.4,.3),e.Volume.Sustain=s(.1),e.Volume.Decay=s(.2,.1),s()<.5&&(e.Filter.HP=s(.3)),T(e),e},Jump:function(){var e=F();return e.Generator.Func="square",e.Generator.A=s(.6),e.Frequency.Start=s(330,330),e.Frequency.Slide=s(.4,.2),e.Volume.Sustain=s(.3,.1),e.Volume.Decay=s(.2,.1),s()<.5&&(e.Filter.HP=s(.3)),s()<.3&&(e.Filter.LP=s(-.6,1)),T(e),e},Select:function(){var e=F();return e.Generator.Func=O(["square","saw"]),e.Generator.A=s(.6),e.Frequency.Start=s(660,220),e.Volume.Sustain=s(.1,.1),e.Volume.Decay=s(.2),e.Filter.HP=.2,T(e),e},Lucky:function(){var e=F();return K(e,function(a,o){var l=t.Module[o].params;K(l,function(f,h){if(f.C){var d=be(f.C);a[h]=d[d.length*V()|0]}else a[h]=V()*(f.H-f.L)+f.L})}),e.Volume.Master=.4,e.Filter={},T(e),e},Synth:function(){var e=F();return e.Generator.Func=O(["square","saw"]),e.Frequency.Start=O([340,240,170]),e.Volume.Attack=s()>.6?s(.5):0,e.Volume.Sustain=s(1),e.Volume.Punch=s(1),e.Volume.Decay=s(.9)+.1,e.Generator.A=s(1),s()<.25&&(e.Filter.HP=s(1)),s()<.25&&(e.Filter.LP=s(1)),T(e),e},Tone:function(){var e=F();return e.Generator.Func="square",e.Frequency.Start=261.6,e.Volume.Sustain=.6441,T(e),e},Click:function(){var e=s()>.5?t.Preset.Hit():t.Preset.Explosion();return s()<.5&&(e.Frequency.Slide=-.5+s(1)),s()<.5&&(e.Volume.Sustain*=s(.4)+.2,e.Volume.Decay*=s(.4)+.2),e.Frequency.Start=s(1200,440),T(e),e}},t.G.unoise=H("sample = Math.random();"),t.G.sine=H("sample = Math.sin(phase);"),t.G.saw=H("sample = 2*(phase/TAU - ((phase/TAU + 0.5)|0));"),t.G.triangle=H("sample = Math.abs(4 * ((phase/TAU - 0.25)%1) - 2) - 1;"),t.G.square=H("var s = Math.sin(phase); sample = s > A ? 1.0 : s < A ? -1.0 : A;"),t.G.synth=H("sample = Math.sin(phase) + .5*Math.sin(phase/2) + .3*Math.sin(phase/4);"),t.G.noise=H("if(phase % TAU < 4){__noiseLast = Math.random() * 2 - 1;} sample = __noiseLast;"),t.G.string={create:function(){for(var e=1<<16,a=e-1,o=z(e),l=0;l<o.length;l++)o[l]=V()*2-1;var f=0;return function(h,d){for(var S=Math.PI*2,p=+h.generatorA,_=+h.generatorASlide,A=+h.generatorB,N=+h.generatorBSlide,M=o,R=0;R<d.length;R++){var wt=d[R],Dt=S/wt|0;p+=_,A+=N,p=p<0?0:p>1?1:p,A=A<0?0:A>1?1:A;var re=f-Dt+e&a,Ft=(M[re-0+e&a]*1+M[re-1+e&a]*p+M[re-2+e&a]*A)/(1+p+A);M[f]=Ft,d[R]=M[f],f=f+1&a}return h.generatorA=p,h.generatorB=A,d.length}}};function H(e){return new Function("$","block",`var TAU = Math.PI * 2;
var sample;
var phase = +$.generatorPhase,
	A = +$.generatorA, ASlide = +$.generatorASlide,
	B = +$.generatorB, BSlide = +$.generatorBSlide;

for(var i = 0; i < block.length; i++){
	var phaseSpeed = block[i];
	phase += phaseSpeed;
	if(phase > TAU){ phase -= TAU };
	A += ASlide; B += BSlide;
   A = A < 0 ? 0 : A > 1 ? 1 : A;
   B = B < 0 ? 0 : B > 1 ? 1 : B;
`+e+`	block[i] = sample;
}

$.generatorPhase = phase;
$.generatorA = A;
$.generatorB = B;
return block.length;
`)}t.CreateAudio=At;function At(e){typeof Float32Array!="undefined"&&J(e instanceof Float32Array,"data must be an Float32Array");var a=i*r>>3,o=t.SampleRate*a,l=Nt(8+36+e.length*2),f=0;function h(S){for(var p=0;p<S.length;p+=1)l[f]=S.charCodeAt(p),f++}function d(S,p){p<=0||(l[f]=S&255,f++,d(S>>8,p-1))}return h("RIFF"),d(36+e.length*2,4),h("WAVEfmt "),d(16,4),d(1,2),d(i,2),d(t.SampleRate,4),d(o,4),d(a,2),d(r,2),h("data"),d(e.length*2,4),xe(l.subarray(f),e),new Audio("data:audio/wav;base64,"+Mt(l))}t.DownloadAsFile=function(e){J(e instanceof Audio,"input must be an Audio object"),document.location.href=e.src},t.Util={},t.Util.CopyFToU8=xe;function xe(e,a){J(e.length/2==a.length,"the target buffer must be twice as large as the iinput");for(var o=0,l=0;l<a.length;l++){var f=+a[l],h=f*32767|0;h=h<-32768?-32768:32767<h?32767:h,h+=h<0?65536:0,e[o]=h&255,o++,e[o]=h>>8,o++}}function Mt(e){for(var a=32768,o="",l=0;l<e.length;l+=a){var f=Math.min(l+a,e.length);o+=String.fromCharCode.apply(null,e.subarray(l,f))}return btoa(o)}function xt(){return typeof g!="undefined"?new g().sampleRate:44100}function J(e,a){if(!e)throw new Error(a)}function bt(e,a,o){return e=+e,a=+a,o=+o,e<a?+a:e>o?+o:+e}function Pt(e){return e=+e,e<0?0:e>1?1:+e}function K(e,a){var o={};for(var l in e)e.hasOwnProperty(l)&&(o[l]=a(e[l],l));return o}function s(e,a){var o=V();return e!==void 0&&(o*=e),a!==void 0&&(o+=a),o}function O(e){return e[e.length*V()|0]}function be(e){var a=[];for(var o in e)a.push(o);return a}t._createFloatArray=z;function z(e){if(typeof Float32Array=="undefined")for(var a=new Array(e),o=0;o<a.length;o++)a[o]=0;return new Float32Array(e)}function Nt(e){if(typeof Uint8Array=="undefined")for(var a=new Array(e),o=0;o<a.length;o++)a[o]=0|0;return new Uint8Array(e)}var Pe=Math.random;t.setRandomFunc=function(e){Pe=e};function V(){return Pe()}})(G={});let I,oe,W,ue,se,le=!1;function Ue(t=void 0){I=t==null?new(window.AudioContext||window.webkitAudioContext):t,ce(),fe(),he()}function Qe(){le||(le=!0,de())}function ce(t=120){oe=t,W=60/oe}function fe(t=8){ue=4/t}function he(t=.1){se=t}function X(t){const n=W*ue;return n>0?Math.ceil(t/n)*n:t}function de(){const t=I.createBufferSource();t.start=t.start||t.noteOn,t.start()}function Je(){I.resume()}class pe{constructor(n=null){U(this,"x");U(this,"y");U(this,"z");U(this,"w");this.setSeed(n)}get(n=1,r){return r==null&&(r=n,n=0),this.next()/4294967295*(r-n)+n}getInt(n,r){r==null&&(r=n,n=0);const i=Math.floor(n),u=Math.floor(r);return u===i?i:this.next()%(u-i)+i}getPlusOrMinus(){return this.getInt(2)*2-1}select(n){return n[this.getInt(n.length)]}setSeed(n,r=123456789,i=362436069,u=521288629,c=32){this.w=n!=null?n>>>0:Math.floor(Math.random()*4294967295)>>>0,this.x=r>>>0,this.y=i>>>0,this.z=u>>>0;for(let m=0;m<c;m++)this.next();return this}getState(){return{x:this.x,y:this.y,z:this.z,w:this.w}}next(){const n=this.x^this.x<<11;return this.x=this.y,this.y=this.z,this.z=this.w,this.w=(this.w^this.w>>>19^(n^n>>>8))>>>0,this.w}}function Ke(t,n){let r=[];for(let i=0;i<t;i++)r.push(n(i));return r}const ve=["coin","laser","explosion","powerUp","hit","jump","select","random","synth","tone","click"],We={coin:"Coin",laser:"Laser",explosion:"Explosion",powerUp:"PowerUp",hit:"Hit",jump:"Jump",select:"Select",random:"Lucky",synth:"Synth",tone:"Tone",click:"Click"},Y=new pe;let Z,me;function Xe(){me=G.Live(),Z=[],G.setRandomFunc(()=>Y.get())}function Ye(t){nt(t)}function Ze(){const t=I.currentTime;Z.forEach(n=>{rt(n,t)})}function j(t=void 0,n=void 0,r=2,i=.05,u=void 0,c=1,m=1){n!=null&&Y.setSeed(n);const v=G.Preset[We[t!=null?t:ve[Y.getInt(8)]]],g=Ke(r,()=>{const L=v();return u!=null&&L.Frequency.Start!=null&&(L.Frequency.Start=u),L.Volume.Attack!=null&&(L.Volume.Attack*=c),L.Volume.Sustain!=null&&(L.Volume.Sustain*=m),L});return je(t,g,i)}function je(t,n,r){const i=n.map(c=>{const m=me._generate(c),v=I.createBuffer(1,m.length,G.SampleRate);var g=v.getChannelData(0);return g.set(m),v}),u=I.createGain();return u.gain.value=r*se,u.connect(I.destination),{type:t,params:n,volume:r,buffers:i,bufferSourceNodes:void 0,gainNode:u,isPlaying:!1,playedTime:void 0}}function $e(t,n,r,i,u){const c=new pe;c.setSeed(r);let m;if(n){let v=c.select(["hit","hit","click","click","explosion"]);i!=null&&(v=i),m=j(v,c.getInt(999999999),v==="explosion"?1:2,u!=null?u:v==="explosion"?.4:.5,c.get(100,200),v==="explosion"?.5:1,v==="explosion"?.2:1)}else{const v=et(t);let g=c.get()<1/v?"select":c.select(["tone","tone","synth"]);i!=null&&(g=i),m=j(g,c.getInt(999999999),g!=="select"?1:2,u!=null?u:g==="tone"?.3:g==="synth"?.4:.25,261.6,g!=="select"?.1:1,g!=="select"?2:1)}return m.isDrum=n,m.seed=r,m}function et(t){if(t==null||t.notes.length===0)return 1;let n=0,r=0;return t.notes.forEach(i=>{const u=i.quantizedEndStep-i.quantizedStartStep;u>0&&(n+=u,r++)}),n/r}function tt(t){Z.push(t)}function nt(t){t.isPlaying=!0}function rt(t,n){if(!t.isPlaying)return;t.isPlaying=!1;const r=X(n);(t.playedTime==null||r>t.playedTime)&&($(t,r),t.playedTime=r)}function $(t,n,r=void 0){t.bufferSourceNodes=[],t.buffers.forEach(i=>{const u=I.createBufferSource();if(u.buffer=i,r!=null&&u.playbackRate!=null){const c=Math.pow(2,1/12);u.playbackRate.value=Math.pow(c,r)}u.start=u.start||u.noteOn,u.connect(t.gainNode),u.start(n),t.bufferSourceNodes.push(u)})}function ee(t,n=void 0){t.bufferSourceNodes!=null&&(t.bufferSourceNodes.forEach(r=>{n==null?r.stop():r.stop(n)}),t.bufferSourceNodes=void 0)}const at=100;function it(t){let n=`${t}`,r;ve.forEach(D=>{const E=`@${D}`,C=n.indexOf(E);C>=0&&(r=D,n=`${n.slice(0,C)}${n.slice(C+E.length)}`)});const i="@d",u=n.indexOf(i);let c=!1;u>=0&&(c=!0,n=`${n.slice(0,u)}${n.slice(u+i.length)}`);const m=n.match(/@s\d+/);let v=1;m!=null&&(v=Number.parseInt(m[0].substring(2)),n=n.replace(/@s\d+/,""));const g=n.match(/v\d+/);let L;return g!=null&&(L=Number.parseInt(g[0].substring(1))/at,n=n.replace(/v\d+/,"")),{mml:n,args:{isDrum:c,seed:v,type:r,volume:L}}}function ot(t,n,r,i){return{mml:t,sequence:n,soundEffect:r,noteIndex:0,endStep:-1,visualizer:i}}function ut(t,n,r){const i=n.sequence.notes[n.noteIndex];i!=null&&((n.soundEffect.type==="synth"||n.soundEffect.type==="tone")&&n.endStep===t.notesStepsIndex&&ee(n.soundEffect,r),i.quantizedStartStep===t.notesStepsIndex&&((n.soundEffect.type==="synth"||n.soundEffect.type==="tone")&&ee(n.soundEffect),n.soundEffect.isDrum?$(n.soundEffect,r):$(n.soundEffect,r,i.pitch-69),n.visualizer!=null&&n.visualizer.redraw(i),n.endStep=i.quantizedEndStep,n.endStep>=t.notesStepsCount&&(n.endStep-=t.notesStepsCount),n.noteIndex++,n.noteIndex>=n.sequence.notes.length&&(n.noteIndex=0)))}let B=[];function st(){pt(),B=[]}function lt(t,n,r=1){t.forEach(u=>{u.noteIndex=0});const i={parts:t,notesStepsCount:n,notesStepsIndex:void 0,noteInterval:void 0,nextNotesTime:void 0,speedRatio:r,isPlaying:!1,isLooping:!1};return Se(i),i}function Se(t){const n=W/4/t.speedRatio;t.notesStepsIndex=0,t.noteInterval=n,t.nextNotesTime=X(I.currentTime)-n}function ct(t){B.push(t)}function ft(t){B=B.filter(n=>n!==t)}function ht(){B.forEach(t=>{vt(t)})}function dt(t,n=!1){t.isLooping=n,Se(t),t.isPlaying=!0}function ye(t){t.isPlaying=!1,t.parts.forEach(n=>{ee(n.soundEffect)})}function pt(){B.forEach(t=>{ye(t)})}function vt(t){if(!t.isPlaying)return;const n=I.currentTime;n<t.nextNotesTime||(t.nextNotesTime+=t.noteInterval,t.nextNotesTime<n&&(t.nextNotesTime=X(n)),t.parts.forEach(r=>{ut(t,r,t.nextNotesTime)}),t.notesStepsIndex++,t.notesStepsIndex>=t.notesStepsCount&&(t.isLooping?t.notesStepsIndex=0:t.isPlaying=!1))}const te=.125;let ge,Q,k;function mt(t,n=1,r=1,i=!0){let u=0;const c=t.map(v=>it(v));c.forEach(v=>{const g=Lt(v.mml);g>u&&(u=g)});const m=c.map(v=>{const{mml:g,args:L}=v,D=_t(g,u),E=$e(D,L.isDrum,L.seed,L.type,L.volume*n);return ot(g,D,E)});k=lt(m,u,r),ct(k),dt(k,i)}function Le(){k!=null&&(ye(k),ft(k),k=void 0)}function St(t=void 0,n=void 0,r=2,i=1,u=void 0){const c=`${t}_${n}_${r}_${i}_${u}`;if(Q[c]==null){const m=j(t,n==null?ge:n,r,i,u);tt(m),Q[c]=m}Ye(Q[c])}function yt(){ht(),Ze()}function gt(t=1,n=void 0){Ae(t),Ue(n),_e()}function _e(){st(),Xe(),Q={},Le()}function Ae(t=1){ge=t}function Lt(t){const n=new ie(t);for(let r of n)if(r.type==="end")return Math.floor(r.time/te)}function _t(t,n){const r=[],i=new ie(t);for(let u of i)if(u.type==="note"){let c=Math.floor((u.time+u.duration)/te);c>=n&&(c-=n),r.push({pitch:u.noteNumber,quantizedStartStep:Math.floor(u.time/te),quantizedEndStep:c})}return{notes:r}}y.init=gt,y.playEmpty=de,y.playMml=mt,y.playSoundEffect=St,y.reset=_e,y.resumeAudioContext=Je,y.setQuantize=fe,y.setSeed=Ae,y.setTempo=ce,y.setVolume=he,y.startAudio=Qe,y.stopMml=Le,y.update=yt,Object.defineProperty(y,"__esModule",{value:!0}),y[Symbol.toStringTag]="Module"});
